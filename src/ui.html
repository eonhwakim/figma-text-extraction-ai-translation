<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <style>
    :root {
      /* Colors - More neutral & sophisticated palette */
      --primary-color: #18A0FB; /* Figma Blue */
      --primary-hover: #0D8CE0;
      --purple-color: #7B61FF; /* Figma Purple */
      --purple-hover: #674CE5;
      --danger-color: #F24822;
      
      --text-main: #333333;
      --text-sub: #8e8e8e; /* Lighter sub text for cleaner look */
      --text-on-primary: #ffffff;

      --bg-main: #ffffff;
      --bg-sub: #F9F9F9; /* Very subtle grey */
      --bg-hover: #F0F0F0;
      
      --border-color: #E6E6E6;
      --border-focus: #18A0FB;

      /* Sharp & Clean */
      --radius-sm: 2px;
      --radius-md: 4px; /* Reduced from 8px for sharper look */
      
      /* Subtle Depth */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      font-family: var(--font-family);
      font-size: 12px; /* Slightly smaller for density */
      color: var(--text-main);
      margin: 0;
      background: var(--bg-main);
      line-height: 1.5;
    }

    /* Scrollbar - Minimalist */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #E6E6E6; border-radius: 4px; border: 2px solid var(--bg-main); }
    ::-webkit-scrollbar-thumb:hover { background: #D1D1D1; }

    /* Layout */
    .container { display: flex; height: 100vh; overflow: hidden; }

    /* Panels */
    .panel-left {
      width: 320px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      background: var(--bg-sub);
      flex-shrink: 0;
    }
    .panel-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-main);
      overflow-y: auto;
      padding: 24px 32px; /* More breathing room */
    }

    /* Headers */
    .header {
      height: 48px;
      padding: 0 16px;
      background: var(--bg-sub);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    h3 { 
      margin: 0; 
      font-size: 12px; 
      font-weight: 600; 
      color: var(--text-main); 
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .badge {
      background: #E6E6E6;
      color: #333;
      padding: 1px 6px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      display: inline-block;
      min-width: 16px;
      text-align: center;
    }

    /* Buttons */
    button {
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.1s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    button:disabled { opacity: 0.4; cursor: default !important; }
    button:active { transform: translateY(1px); }

    .icon-btn {
      width: 28px;
      height: 28px;
      background: transparent;
      color: var(--text-sub);
      border-radius: var(--radius-sm);
    }
    .icon-btn:hover:not(:disabled) { background: rgba(0,0,0,0.05); color: var(--text-main); }
    
    .btn-primary {
      background: var(--primary-color);
      color: var(--text-on-primary);
      font-weight: 500;
      padding: 6px 16px;
      border: 1px solid var(--primary-color);
    }
    .btn-primary:hover:not(:disabled) { background: var(--primary-hover); border-color: var(--primary-hover); }

    .btn-purple {
      background: var(--purple-color);
      color: white;
      font-weight: 500;
      padding: 6px 16px;
      border: 1px solid var(--purple-color);
    }
    .btn-purple:hover:not(:disabled) { background: var(--purple-hover); border-color: var(--purple-hover); }

    .btn-secondary {
      background: white;
      color: var(--text-main);
      border: 1px solid var(--border-color);
      font-weight: 500;
      padding: 6px 16px;
    }
    .btn-secondary:hover:not(:disabled) { border-color: #ccc; background: #fafafa; }

    .btn-text {
      background: none;
      color: var(--text-sub);
      font-size: 11px;
      padding: 0;
      text-decoration: none;
      border: none;
    }
    .btn-text:hover { color: var(--primary-color); text-decoration: underline; }

    /* List View */
    .list { 
      padding: 8px;
      display: flex; 
      flex-direction: column; 
      gap: 4px; /* Tighter gap */
      flex: 1; 
      overflow-y: auto; 
    }
    
    .item { 
      display: flex; 
      gap: 8px; 
      align-items: center; /* Center vertically */
      background: white;
      border: 1px solid transparent; /* No border by default for cleaner look */
      padding: 6px 10px; 
      border-radius: var(--radius-sm); 
      transition: background 0.1s;
      position: relative;
    }
    .item:hover { 
      background: var(--bg-hover);
    }
    .item.merge-selected { 
      background: #F0F5FF; /* Subtle blue tint */
      border: 1px solid #B4D5FF;
    }
    /* Active State for Translate Button (if needed) */
    .item.active-detail {
        background: #F0F9FF; /* Light blue background for currently viewing item */
        border: 1px solid #BAE6FD;
    }

    .item.excluded { opacity: 0.5; }
    .item.excluded .content { text-decoration: line-through; color: var(--text-sub); }
    
    .checkbox-wrapper { display: flex; align-items: center; }
    input[type="checkbox"] { 
      cursor: pointer; 
      width: 14px; 
      height: 14px; 
      margin: 0; 
      accent-color: var(--primary-color);
      border-radius: 2px; /* Sharper checkbox */
    }

    .content-wrapper { flex: 1; cursor: pointer; min-width: 0; display:flex; flex-direction:column; justify-content:center; }
    .content { 
      white-space: pre-wrap; 
      word-break: break-all; 
      line-height: 1.4; 
      color: var(--text-main); 
      font-size: 12px;
    }
    
    .merged-badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 4px;
      font-size: 9px; 
      color: #fff; 
      background: var(--purple-color); 
      padding: 1px 5px; 
      border-radius: 2px; 
      margin-bottom: 2px;
      cursor: pointer; 
      font-weight: 600;
      letter-spacing: 0.05em;
      align-self: flex-start;
    }
    .merged-badge:hover { background: var(--purple-hover); }
    
    .item-actions {
      display: flex;
      flex-direction: row; /* Horizontal layout */
      gap: 4px;
      opacity: 1; /* Always visible */
      flex-shrink: 0;
      align-items: center;
    }

    .action-btn-small {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-sub);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .action-btn-small:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
    
    /* Active/Selected Button States */
    .item.merge-selected .merge-btn { 
      color: white;
      background: var(--purple-color);
      border-color: var(--purple-color);
    }
    
    /* When detail is open for this item, highlight translate button */
    .item.active-detail .translate-icon {
        color: white;
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    .empty { 
      height: 100%; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      color: var(--text-sub); 
      text-align: center;
      gap: 12px;
      font-size: 13px;
    }
    .empty-icon { font-size: 24px; opacity: 0.3; margin-bottom: 4px; filter: grayscale(1); }

    .footer {
      padding: 12px 16px; 
      background: white; 
      border-top: 1px solid var(--border-color);
      display: flex; 
      gap: 8px; 
      flex-shrink: 0;
    }
    .footer button { flex: 1; height: 32px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.03em; }

    /* Detail & Batch View */
    .detail-placeholder { 
      color: var(--text-sub); 
      text-align: center; 
      margin: auto;
      font-size: 13px; 
      max-width: 240px;
      line-height: 1.6;
    }
    .detail-placeholder strong { color: var(--text-main); font-weight: 600; }

    .detail-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      margin-bottom: 24px; 
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 12px;
    }
    .detail-header h3 { font-size: 14px; text-transform: none; }

    .section { 
      margin-bottom: 24px; 
    }
    .section-title { 
      font-weight: 600; 
      margin-bottom: 8px; 
      font-size: 11px; 
      color: var(--text-sub); 
      text-transform: uppercase; 
      letter-spacing: 0.05em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .source-text { 
      font-size: 14px; 
      line-height: 1.6;
      color: var(--text-main);
      padding: 16px; 
      background: #FAFAFA; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-sm); 
      margin-bottom: 24px;
      white-space: pre-wrap;
    }

    .match-item { 
      padding: 8px 12px; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-sm); 
      margin-bottom: 6px; 
      font-size: 12px; 
      background: white;
    }
    .match-key { color: var(--text-sub); font-size: 10px; margin-bottom: 4px; display:flex; align-items:center; letter-spacing: 0.02em;}
    .match-val { color: var(--text-main); font-weight: 500; }
    .match-tag { font-size: 9px; padding: 1px 4px; border-radius: 2px; margin-left: auto; font-weight:600; text-transform: uppercase; }
    .tag-exact { background: #E6FFFA; color: #047481; }
    .tag-pattern { background: #EBF8FF; color: #2C5282; }
    .tag-partial { background: #FFFAF0; color: #9C4221; }

    textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 12px;
      resize: vertical;
      box-sizing: border-box;
      background: #FAFAFA;
      color: var(--text-main);
    }
    textarea:focus { outline: none; border-color: var(--border-focus); background: white; }

    .translate-btn { width: 100%; background: #333; color: white; padding: 10px; border-radius: var(--radius-sm); text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; font-weight: 600;}
    .translate-btn:hover { background: #000; }

    /* Translation Results */
    .suggestion { 
      margin-top: 16px; 
      padding-top: 16px; 
      border-top: 1px solid var(--border-color); 
    }
    .lang-title { 
      font-weight: 600; 
      color: var(--text-main); 
      margin-bottom: 12px; 
      font-size: 12px; 
      display:flex; align-items:center; gap:6px;
    }
    .trans-option { 
      margin-bottom: 8px; 
      padding: 12px; 
      background: white; 
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      transition: border-color 0.2s;
    }
    .trans-option:hover { border-color: #999; }
    .trans-text { font-weight: 500; color: var(--text-main); font-size: 13px; margin-bottom: 4px; }
    .trans-nuance { font-size: 11px; color: var(--text-sub); }
    
    .recommendation { 
      margin-top: 16px; 
      padding: 12px; 
      background: #F0FDFA; 
      border: 1px solid #CCFBF1;
      border-radius: var(--radius-sm); 
      color: #0F766E; 
      font-size: 12px; 
      line-height: 1.5;
    }

    .loading { text-align: center; color: var(--text-sub); padding: 30px; font-size: 12px; }

    /* Modal */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0, 0, 0, 0.4); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 100; 
    }
    .modal { 
      background: white; 
      padding: 24px; 
      border-radius: var(--radius-md); 
      width: 320px; 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); 
    }
    .modal h4 { margin: 0 0 16px 0; font-size: 14px; color: var(--text-main); }
    .modal input { 
      width: 100%; padding: 10px; margin-bottom: 8px; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-sm); 
      box-sizing: border-box; 
      font-family: monospace; 
      font-size: 12px;
    }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    
    /* Batch List */
    .batch-list-container {
      max-height: 200px;
      overflow-y: auto;
      background: #FAFAFA;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 0;
    }
    .batch-item-row {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
      color: var(--text-main);
      background: white;
    }
    .batch-item-row:last-child { border-bottom: none; }
    .batch-item-row:nth-child(even) { background: #FAFAFA; }

  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANEL -->
    <div class="panel-left">
      <!-- EXTRACT VIEW -->
      <div id="extractView" style="display:flex; flex-direction:column; height:100%;">
        <div class="header">
          <div style="display:flex; align-items:center; gap:10px;">
            <h3>ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h3>
            <span id="count" class="badge">0</span>
            <button id="btnAdd" class="icon-btn" title="ì„ íƒëœ í…ìŠ¤íŠ¸ ì¶”ê°€ (Cmd+Enter)" style="color:var(--primary-color);">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3.5a.5.5 0 0 1 .5.5v3.5h3.5a.5.5 0 0 1 0 1H8.5v3.5a.5.5 0 0 1-1 0V8.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z"/></svg>
            </button>
          </div>
          <div style="display:flex; align-items:center; gap:2px;">
            <button id="btnSettings" class="icon-btn" title="ì„¤ì • (API Key)">
               <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zM8.354 2.65a.544.544 0 0 0-.708 0l-.145.492a1.873 1.873 0 0 0-2.694 1.116l-.491.144c-.282.083-.4.407-.229.63l.348.455c.48.629.48 1.503 0 2.132l-.348.454a.397.397 0 0 0 .23.631l.49.144a1.873 1.873 0 0 0 2.695 1.116l.145.492c.082.28.407.4.63.229l.454-.349a1.734 1.734 0 0 0 2.132 0l.455.349c.222.17.547.051.629-.23l.145-.491a1.873 1.873 0 0 0 2.694-1.116l.491-.145c.282-.082.4-.407.23-.63l-.349-.454a1.735 1.735 0 0 0 0-2.133l.349-.454c.17-.223.051-.548-.23-.63l-.49-.145a1.873 1.873 0 0 0-2.695-1.116l-.145-.491c-.082-.281-.407-.4-.629-.23l-.455.349a1.734 1.734 0 0 0-2.132 0l-.454-.349c-.223-.17-.548-.051-.63.23z"/></svg>
            </button>
            <button id="btnClear" class="icon-btn" title="ëª©ë¡ ì´ˆê¸°í™”">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
            </button>
          </div>
        </div>
        
        <div id="list" class="list">
          <div class="empty">
            <div class="empty-icon">ğŸ“‚</div>
            <div>ì¶”ì¶œí•  í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼<br>ì„ íƒ í›„ ì¶”ê°€í•˜ì„¸ìš”.</div>
          </div>
        </div>

        <div class="footer">
          <button id="btnCopy" class="btn-secondary" disabled>ë³µì‚¬</button>
          <button id="btnBatch" class="btn-secondary" style="background:#FFF1F2; color:#BE123C; border-color:#FECDD3;" disabled>ì¼ê´„ ë²ˆì—­</button>
          <button id="btnMergeAction" class="btn-purple" disabled>í•©ì¹˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="detailView" class="panel-right">
      <div id="detailPlaceholder" class="detail-placeholder">
        ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ê±°ë‚˜<br>
        <strong>ì¼ê´„ ë²ˆì—­</strong> ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.
      </div>

      <!-- Single Detail View -->
      <div id="detailContent" style="display:none;">
        <div class="detail-header">
          <h3>ë²ˆì—­ ë° ë¦¬ì†ŒìŠ¤ í™•ì¸</h3>
        </div>
        
        <div class="source-text" id="detailSourceText"></div>

        <div class="section">
          <div class="section-title">ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰ ê²°ê³¼</div>
          <div id="resourceMatches">
            <div class="loading">ê²€ìƒ‰ ì¤‘...</div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Context (ì„ íƒ ì‚¬í•­)</div>
          <textarea id="contextInput" placeholder="ë²ˆì—­ ì‹œ ì°¸ê³ í•  ë¬¸ë§¥ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¡œê·¸ì¸ í™”ë©´ ì—ëŸ¬ ë©”ì‹œì§€)"></textarea>
        </div>

        <div class="section">
          <div class="section-title">
            AI ë²ˆì—­ ì œì•ˆ
            <button id="btnSetKey" class="btn-text">API Key ì„¤ì •</button>
          </div>
          
          <div id="translationResult"></div>
          <div style="margin-top: 12px;">
            <button id="btnTranslate" class="translate-btn">ë²ˆì—­ ì‹¤í–‰</button>
          </div>
        </div>
      </div>

      <!-- Batch View -->
      <div id="batchView" style="display:none;">
        <div class="detail-header">
          <h3>ì¼ê´„ AI ë²ˆì—­</h3>
        </div>

        <div class="section">
           <div class="section-title">ì„ íƒëœ í•­ëª© (<span id="batchCount">0</span>ê°œ)</div>
           <div id="batchList" class="batch-list-container"></div>
        </div>

        <div class="section">
          <div class="section-title">Context (ê³µí†µ ì ìš©)</div>
          <textarea id="batchContextInput" placeholder="ëª¨ë“  í•­ëª©ì— ì ìš©í•  ë¬¸ë§¥ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>

        <div class="section">
          <div class="section-title">
            ì‹¤í–‰
            <button id="btnSetKeyBatch" class="btn-text">API Key ì„¤ì •</button>
          </div>
          
          <div id="batchResult"></div>
          <div style="margin-top: 12px;">
            <button id="btnBatchRun" class="translate-btn">ì¼ê´„ ë²ˆì—­ ì‹¤í–‰</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Key Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal">
      <h4>OpenAI API Key ì„¤ì •</h4>
      <input type="password" id="modalApiKeyInput" placeholder="sk-...">
      <div style="font-size: 11px; color: var(--text-sub); margin-bottom: 20px; line-height: 1.5;">
        í‚¤ëŠ” ë¸Œë¼ìš°ì € ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
      </div>
      <div class="modal-footer">
        <button id="btnCancelKey" class="btn-secondary">ì·¨ì†Œ</button>
        <button id="btnSaveKey" class="btn-primary">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    let currentData = [];
    let currentDetailItem = null;
    let currentDetailMatches = [];
    let batchResults = null; // ë²ˆì—­ ê²°ê³¼ ì €ì¥ìš©
    let batchContext = '';

    // TODO: ì½”ë“œì— API Keyë¥¼ ì§ì ‘ ë„£ìœ¼ë ¤ë©´ ì•„ë˜ ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    let apiKey = '';

    try {
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ í‚¤ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      const storedKey = localStorage.getItem('openai_api_key');
      if (storedKey) apiKey = storedKey;
    } catch(e) {}

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'selection-update') {
        // Auto feature removed. Ignoring selection updates.
        return;
      }

      if (msg.type === 'add-items') {
        const newData = msg.data;
        const existingMap = new Map(currentData.map(d => [d.ids.join(','), d]));
        let added = false;
        
        newData.forEach(d => {
           const key = d.ids.join(',');
           if (!existingMap.has(key)) {
             currentData.push({ ...d, checked: true, mergeSelected: false, originalItems: null });
             added = true;
           }
        });
        
        if (added) {
          render();
          saveState();
        }
      }

      if (msg.type === 'restore-state') {
        if (msg.data && Array.isArray(msg.data)) {
           const existingMap = new Map(currentData.map(d => [d.ids.join(','), d]));
           msg.data.forEach(item => {
             const key = item.ids.join(',');
             if (!existingMap.has(key)) {
               currentData.push(item);
             }
           });
           render();
        }
      }

      if (msg.type === 'translation-check-result') {
        currentDetailMatches = msg.data || [];
        renderResourceMatches(msg.data, msg.originalText);
      }

      if (msg.type === 'batch-translation-check-result') {
        runBatchOpenAI(msg.data);
      }

      if (msg.type === 'restore-batch-results') {
        batchResults = msg.data;
        // ë§Œì•½ í˜„ì¬ ë°°ì¹˜ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ë°”ë¡œ ë Œë”ë§
        if (document.getElementById('batchView').style.display === 'block') {
           renderBatchResults(batchResults);
        }
      }

      if (msg.type === 'restore-batch-context') {
        batchContext = msg.data || '';
        document.getElementById('batchContextInput').value = batchContext;
      }
    };

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        parent.postMessage({ pluginMessage: { type: 'add-selection' } }, '*');
      }
    });

    function render() {
      const list = document.getElementById('list');
      list.innerHTML = '';
      
      const checkedCount = currentData.filter(d => d.checked).length;
      document.getElementById('count').innerText = `${checkedCount}`;
      
      const btns = document.querySelectorAll('#listView button:not(.action-btn):not(#btnClear)');
      if (currentData.length === 0) {
        list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‚</div><div>ì¶”ì¶œí•  í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼<br>ì„ íƒ í›„ ì¶”ê°€í•˜ì„¸ìš”.</div></div>`;
        return;
      }
      
      document.getElementById('btnCopy').disabled = checkedCount === 0;
      document.getElementById('btnBatch').disabled = checkedCount === 0;

      const mergeCount = currentData.filter(d => d.mergeSelected).length;
      const mergeBtn = document.getElementById('btnMergeAction');
      mergeBtn.disabled = mergeCount < 2;
      mergeBtn.innerText = mergeCount > 0 ? `í•©ì¹˜ê¸° (${mergeCount})` : "í•©ì¹˜ê¸°";

      currentData.forEach((item, index) => {
        const div = document.createElement('div');
        // Check if this item is the one currently being viewed in detail
        const isDetailActive = currentDetailItem && currentDetailItem.ids.join(',') === item.ids.join(',');
        
        div.className = `item ${item.checked ? '' : 'excluded'} ${item.mergeSelected ? 'merge-selected' : ''} ${isDetailActive ? 'active-detail' : ''}`;
        
        const isMerged = !!item.originalItems;
        
        div.innerHTML = `
          <div class="checkbox-wrapper" title="ëª©ë¡ì—ì„œ ì œì™¸">
            <input type="checkbox" ${item.checked ? 'checked' : ''}>
          </div>
          <div class="content-wrapper">
            ${isMerged ? '<span class="merged-badge" title="ë³‘í•© í•´ì œí•˜ë ¤ë©´ í´ë¦­">MERGED</span>' : ''}
            <div class="content">${escapeHtml(item.text)}</div>
          </div>
          <div class="item-actions">
             <div class="action-btn-small translate-icon" title="ë²ˆì—­ ë° í™•ì¸">
               <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M12.5 14h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-.5.5zM3 4v9h9V4H3z"/><path d="M5.5 6.5A.5.5 0 0 1 6 6h4a.5.5 0 0 1 0 1H8.5v4a.5.5 0 0 1-1 0V7H6a.5.5 0 0 1-.5-.5z"/></svg>
             </div>
             <div class="action-btn-small merge-btn" title="ë³‘í•© ëŒ€ìƒìœ¼ë¡œ ì„ íƒ">
               ${item.mergeSelected ? 'âœ“' : '+'}
             </div>
          </div>
        `;
        
        div.querySelector('input').onchange = (e) => {
          const isChecked = e.target.checked;
          
          if (!isChecked) {
            const idx = currentData.indexOf(item);
            if (idx > -1) {
              currentData.splice(idx, 1);
            }
            parent.postMessage({ pluginMessage: { type: 'clear-highlights', ids: item.ids } }, '*');
          } else {
            item.checked = true;
          }
          
          render();
          saveState();
        };
        
        div.querySelector('.content-wrapper').onclick = (e) => {
          if (e.target.closest('.merged-badge')) return;
          focusNodes(item.ids);
        };

        const badge = div.querySelector('.merged-badge');
        if (badge) {
          badge.onclick = (e) => {
            e.stopPropagation();
            unmergeItem(index);
          };
        }
        
        const transIcon = div.querySelector('.translate-icon');
        if (transIcon) {
          transIcon.onclick = (e) => {
            e.stopPropagation();
            openDetail(item);
          };
        }

        div.querySelector('.merge-btn').onclick = (e) => {
          e.stopPropagation();
          item.mergeSelected = !item.mergeSelected;
          render();
          saveState();
        };

        list.appendChild(div);
      });
    }
    // --- Persistence ---
    function saveState() {
      parent.postMessage({ pluginMessage: { type: 'save-state', data: currentData } }, '*');
    }

    document.getElementById('btnClear').onclick = () => {
      if (confirm('ì „ì²´ ëª©ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        currentData = [];
        batchResults = null; 
        batchContext = ''; 
        document.getElementById('batchContextInput').value = '';
        currentDetailItem = null; // Clear detail view ref
        
        parent.postMessage({ pluginMessage: { type: 'save-batch-results', data: null } }, '*');
        parent.postMessage({ pluginMessage: { type: 'save-batch-context', data: '' } }, '*');
        parent.postMessage({ pluginMessage: { type: 'save-state', data: [] } }, '*');
        parent.postMessage({ pluginMessage: { type: 'clear-highlights' } }, '*');
        
        render();
        // Hide detail view
        document.getElementById('detailContent').style.display = 'none';
        document.getElementById('batchView').style.display = 'none';
        document.getElementById('detailPlaceholder').style.display = 'block';
      }
    };

    document.getElementById('btnAdd').onclick = () => {
       parent.postMessage({ pluginMessage: { type: 'add-selection' } }, '*');
    };


    function openDetail(item) {
      currentDetailItem = item;
      currentDetailMatches = [];
      
      // Re-render list to show active state
      render();

      document.getElementById('detailPlaceholder').style.display = 'none';
      document.getElementById('batchView').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';
      
      document.getElementById('detailSourceText').innerText = item.text;
      document.getElementById('resourceMatches').innerHTML = '<div class="loading">ê²€ìƒ‰ ì¤‘...</div>';
      document.getElementById('translationResult').innerHTML = '';
      
      parent.postMessage({ pluginMessage: { type: 'check-translation', text: item.text } }, '*');
    }

    function renderResourceMatches(matches, originalText) {
      const container = document.getElementById('resourceMatches');
      if (!matches || matches.length === 0) {
        container.innerHTML = '<div class="match-item" style="color:var(--text-sub); text-align:center; border:none; background:none;">ì¼ì¹˜í•˜ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      container.innerHTML = matches.map(m => {
        let tagClass = 'tag-partial';
        if (m.type === 'EXACT') tagClass = 'tag-exact';
        if (m.type === 'PATTERN_MATCH') tagClass = 'tag-pattern';
        
        return `
        <div class="match-item">
          <div class="match-key">${m.key} <span class="match-tag ${tagClass}">${m.type}</span></div>
          <div class="match-val" style="color: #0369A1; font-weight: 600; margin-bottom: 2px; display:inline-block;">ğŸ‡ºğŸ‡¸ ${escapeHtml(m.value)}</div>
          ${m.deValue ? `<div class="match-val" style="margin-top:2px; color:var(--text-sub); font-size:11px;">ğŸ‡©ğŸ‡ª ${escapeHtml(m.deValue)}</div>` : ''}
          ${m.frValue ? `<div class="match-val" style="margin-top:2px; color:var(--text-sub); font-size:11px;">ğŸ‡«ğŸ‡· ${escapeHtml(m.frValue)}</div>` : ''}
        </div>
      `}).join('');
    }

    // --- Batch View Logic ---
    
    document.getElementById('batchContextInput').addEventListener('input', (e) => {
      const val = e.target.value;
      batchContext = val;
      parent.postMessage({ pluginMessage: { type: 'save-batch-context', data: val } }, '*');
    });

    document.getElementById('btnBatch').onclick = () => {
       const selectedItems = currentData.filter(d => d.checked);
       if (selectedItems.length === 0) return;

       document.getElementById('detailPlaceholder').style.display = 'none';
       document.getElementById('detailContent').style.display = 'none';
       document.getElementById('batchView').style.display = 'block';

       document.getElementById('batchCount').innerText = selectedItems.length;
       
       const listEl = document.getElementById('batchList');
       listEl.innerHTML = selectedItems.map(item => `
         <div class="batch-item-row">
           ${escapeHtml(item.text)}
         </div>
       `).join('');
       
       document.getElementById('batchResult').innerHTML = '';

       if (batchResults) {
         renderBatchResults(batchResults);
       }
    };

    document.getElementById('btnSetKeyBatch').onclick = () => {
        document.getElementById('btnSetKey').click(); 
    };

    document.getElementById('btnBatchRun').onclick = () => {
        const selectedItems = currentData.filter(d => d.checked);
        if (selectedItems.length === 0) return;
        
        if (!apiKey) {
            alert('OpenAI API Keyë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
            return;
        }

        const btn = document.getElementById('btnBatchRun');
        btn.disabled = true;
        btn.innerText = 'ì²˜ë¦¬ ì¤‘...';
        document.getElementById('batchResult').innerHTML = '<div class="loading">ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰ ì¤‘...</div>';

        parent.postMessage({ pluginMessage: { type: 'check-batch-translation', items: selectedItems } }, '*');
    };

    async function runBatchOpenAI(itemsWithMatches) {
        const btn = document.getElementById('btnBatchRun');
        const resultArea = document.getElementById('batchResult');
        const context = document.getElementById('batchContextInput').value.trim();

        try {
            resultArea.innerHTML = '<div class="loading">ë²ˆì—­ ìš”ì²­ ì¤‘...</div>';

            const itemsPrompt = itemsWithMatches.map((item, idx) => {
                let refText = "";
                if (item.matches && item.matches.length > 0) {
                     refText = "   Matches: " + item.matches.map(m => {
                         const parts = [`"${m.value}"`];
                         if (m.deValue) parts.push(`DE: "${m.deValue}"`);
                         if (m.frValue) parts.push(`FR: "${m.frValue}"`);
                         return `[${parts.join(', ')}]`;
                     }).join(", ");
                }
                return `Item ${idx + 1}: "${item.text}"${refText ? '\n' + refText : ''}`;
            }).join('\n\n');

            const prompt = `
              Translate the following list of UI texts into French (fr) and German (de).
              Context: Mobile app/webtoon platform (Tappytoon).
              ${context ? `User Context: ${context}` : ''}
              
              Requirements:
              1. Provide 3 options for each language.
              2. Explain the nuance for each option briefly in Korean.
              3. Recommend the best option in Korean.

              Each item may have "Matches" listed below it. These are existing similar translations in our database. Use them as a reference for consistency.

              List of items to translate:
              ${itemsPrompt}
              
              Output JSON format:
              {
                "results": [
                  {
                    "original": "Original Text",
                    "fr": [ { "text": "...", "nuance": "..." }, ... ],
                    "de": [ { "text": "...", "nuance": "..." }, ... ],
                    "recommendation": "Brief reason"
                  },
                  ...
                ]
              }
              Ensure the order matches the input list.
            `;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" }
              })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const content = JSON.parse(data.choices[0].message.content);
            
            batchResults = content.results;
            parent.postMessage({ pluginMessage: { type: 'save-batch-results', data: batchResults } }, '*');
            
            renderBatchResults(content.results);

        } catch (err) {
            resultArea.innerHTML = `<div style="color:red; padding:10px;">Error: ${err.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = 'ì¼ê´„ ë²ˆì—­ ì‹¤í–‰';
        }
    }

    function renderBatchResults(results) {
        const container = document.getElementById('batchResult');
        if (!results || !Array.isArray(results)) {
            container.innerHTML = '<div style="padding:10px;">ê²°ê³¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '';
        results.forEach((res, idx) => {
             html += `<div class="section" style="border-left: 3px solid var(--primary-color);">
               <div style="font-weight:600; margin-bottom:8px; font-size:13px;">${idx+1}. ${escapeHtml(res.original)}</div>`;
             
             ['fr', 'de'].forEach(lang => {
                const langName = lang === 'fr' ? 'ğŸ‡«ğŸ‡· French' : 'ğŸ‡©ğŸ‡ª German';
                const options = res[lang];
                html += `<div style="margin-top:8px;"><div style="font-size:12px; font-weight:600; color:var(--text-sub); margin-bottom:4px;">${langName}</div>`;
                if (Array.isArray(options)) {
                   options.forEach(opt => {
                       html += `<div class="trans-option" style="margin-bottom:4px;"><div class="trans-text" style="font-size:12px;">${escapeHtml(opt.text)}</div><div class="trans-nuance" style="font-size:11px;">${escapeHtml(opt.nuance)}</div></div>`;
                   });
                }
                html += `</div>`;
             });
             
             if (res.recommendation) {
                 html += `<div class="recommendation" style="font-size:11px; margin-top:8px;">ğŸ’¡ AI ì¶”ì²œ ì˜ê²¬: ${escapeHtml(res.recommendation)}</div>`;
             }
             html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    // --- OpenAI Translation Logic ---

    function openSettingsModal() {
      document.getElementById('modalApiKeyInput').value = apiKey;
      document.getElementById('settingsModal').style.display = 'flex';
      document.getElementById('modalApiKeyInput').focus();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    document.getElementById('btnSettings').onclick = openSettingsModal;
    document.getElementById('btnSetKey').onclick = openSettingsModal;

    document.getElementById('btnCancelKey').onclick = closeSettingsModal;
    
    document.getElementById('btnSaveKey').onclick = () => {
      const input = document.getElementById('modalApiKeyInput');
      const newKey = input.value.trim();
      if (!newKey) {
        alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      apiKey = newKey;
      localStorage.setItem('openai_api_key', apiKey);
      closeSettingsModal();
      alert('API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    document.getElementById('btnTranslate').onclick = async () => {
      if (!apiKey) {
        openSettingsModal();
        return;
      }

      const btn = document.getElementById('btnTranslate');
      const resultArea = document.getElementById('translationResult');
      
      btn.disabled = true;
      btn.innerText = 'ë²ˆì—­ ì¤‘...';
      resultArea.innerHTML = '';

      try {
        const text = currentDetailItem.text;
        const context = document.getElementById('contextInput').value.trim();
        
        let referenceText = "";
        if (currentDetailMatches && currentDetailMatches.length > 0) {
           referenceText = "\nExisting Resources (Reference):\n" + currentDetailMatches.map(m => {
             const parts = [`Key: ${m.key}`, `EN: "${m.value}"`];
             if (m.deValue) parts.push(`DE: "${m.deValue}"`);
             if (m.frValue) parts.push(`FR: "${m.frValue}"`);
             return "- " + parts.join(", ");
           }).join("\n");
        }

        const prompt = `
          Translate the following text into French (fr) and German (de).
          Context: Mobile app/webtoon platform (Tappytoon).
          ${context ? `User Context: ${context}` : ''}
          ${referenceText}
          
          Source Text: "${text}"
          
          Requirements:
          1. Provide 3 options for each language.
          2. Explain the nuance for each option briefly in Korean.
          3. Recommend the best option in Korean.
          
          Output JSON format:
          {
            "fr": [ { "text": "...", "nuance": "..." }, ... ],
            "de": [ { "text": "...", "nuance": "..." }, ... ],
            "recommendation": "Explain which option is best and why."
          }
        `;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            response_format: { type: "json_object" }
          })
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }

        const content = JSON.parse(data.choices[0].message.content);
        renderTranslationResult(content);

      } catch (err) {
        resultArea.innerHTML = `<div style="color:red; padding:10px;">Error: ${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.innerText = 'ë²ˆì—­ ì‹¤í–‰';
      }
    };

    function renderTranslationResult(data) {
      const container = document.getElementById('translationResult');
      let html = '';

      ['fr', 'de'].forEach(lang => {
        const langName = lang === 'fr' ? 'French ğŸ‡«ğŸ‡·' : 'German ğŸ‡©ğŸ‡ª';
        const options = data[lang];
        html += `<div class="suggestion"><div class="lang-title">${langName}</div>`;
        if (Array.isArray(options)) {
          options.forEach(opt => {
            html += `
              <div class="trans-option">
                <div class="trans-text">${escapeHtml(opt.text)}</div>
                <div class="trans-nuance">${escapeHtml(opt.nuance)}</div>
              </div>
            `;
          });
        }
        html += `</div>`;
      });

      if (data.recommendation) {
        html += `<div class="recommendation"><strong>ğŸ’¡ AI ì¶”ì²œ ì˜ê²¬:</strong><br>${escapeHtml(data.recommendation)}</div>`;
      }

      container.innerHTML = html;
    }

    function unmergeItem(index) {
      const item = currentData[index];
      if (!item.originalItems) return;
      const restoredItems = item.originalItems.map(original => ({
        ...original,
        checked: true,
        mergeSelected: false
      }));
      currentData.splice(index, 1, ...restoredItems);
      render();
      updateCanvasSelection();
    }

    function updateCanvasSelection() {
      const allCheckedIds = currentData
        .filter(d => d.checked)
        .flatMap(d => d.ids);
      parent.postMessage({ pluginMessage: { type: 'update-selection', ids: allCheckedIds } }, '*');
    }

    function focusNodes(ids) {
      parent.postMessage({ pluginMessage: { type: 'focus-nodes', ids: ids } }, '*');
    }

    document.getElementById('btnMergeAction').onclick = () => {
      const selectedItems = currentData.filter(d => d.mergeSelected);
      if (selectedItems.length < 2) return;

      const newText = selectedItems.map(d => d.text).join(' ');
      const newIds = selectedItems.flatMap(d => d.ids);

      const newItem = {
        ids: newIds,
        text: newText,
        checked: true,
        mergeSelected: false,
        originalItems: selectedItems
      };

      const firstMergeIndex = currentData.findIndex(d => d.mergeSelected);
      const newData = [];
      
      currentData.forEach((item, index) => {
        if (index === firstMergeIndex) {
          newData.push(newItem);
        } 
        if (!item.mergeSelected) {
           if (index !== firstMergeIndex) newData.push(item);
        }
      });
      
      currentData = newData;
      render();
      updateCanvasSelection();
    };

    document.getElementById('btnCopy').onclick = () => {
      const text = currentData.filter(d => d.checked).map(d => d.text).join('\n');
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      
      const btn = document.getElementById('btnCopy');
      const original = btn.innerText;
      btn.innerText = "ì™„ë£Œ!";
      setTimeout(() => btn.innerText = original, 1000);
    };

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
