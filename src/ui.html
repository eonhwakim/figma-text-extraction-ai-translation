<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Inter, sans-serif; padding: 16px; font-size: 13px; color: #333; margin: 0; background: #F5F5F5; }
    
    .header { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    h3 { margin: 0; font-size: 14px; font-weight: 600; }
    .badge { background: #E5F4FF; color: #0077C8; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    
    /* Layout */
    .container { display: flex; height: 100vh; overflow: hidden; }
    
    /* Left Panel */
    .panel-left { width: 340px; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #F5F5F5; flex-shrink: 0; }
    
    /* Right Panel */
    .panel-right { flex: 1; display: flex; flex-direction: column; background: white; overflow-y: auto; padding: 16px; }
    
    /* View Management (Deprecating toggle, making them panels) */
    /* .view { display: none; } */
    /* .view.active { display: block; } */

    /* List View Styles */
    .list { 
      display: flex; flex-direction: column; gap: 8px; 
      flex: 1; overflow-y: auto; padding-bottom: 10px;
    }
    
    .item { 
      display: flex; gap: 8px; align-items: center; 
      border: 1px solid #e0e0e0; 
      padding: 8px 10px; 
      border-radius: 6px; 
      background: white; 
      transition: all 0.2s;
    }
    .item:hover { border-color: #bbb; }
    .item.merge-selected { border-color: #9747FF; background: #F3E5FF; }
    .item.excluded { opacity: 0.6; }
    .item.excluded .content { text-decoration: line-through; color: #aaa; }
    
    .checkbox-wrapper { display: flex; align-items: center; }
    input[type="checkbox"] { cursor: pointer; width: 16px; height: 16px; margin: 0; accent-color: #18A0FB; }

    .content-wrapper { flex: 1; cursor: pointer; overflow: hidden; }
    .content { white-space: pre-wrap; word-break: break-all; line-height: 1.4; color: #333; }
    
    .merged-badge { 
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 10px; color: #fff; background: #9747FF; 
      padding: 2px 6px; border-radius: 10px; margin-bottom: 4px;
      cursor: pointer; transition: background 0.2s;
    }
    .merged-badge:hover { background: #7B2FDB; }
    .merged-badge .close-icon { font-weight: bold; font-size: 9px; }

    .action-btn {
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 4px; border: 1px solid #ddd;
      background: white; color: #666; cursor: pointer;
      font-size: 14px; flex-shrink: 0;
    }
    .action-btn:hover { background: #f0f0f0; border-color: #ccc; }
    .item.merge-selected .merge-btn { background: #9747FF; color: white; border-color: #9747FF; }

    .empty { height: 100%; display: flex; align-items: center; justify-content: center; color: #999; text-align: center; }

    .footer {
      padding: 12px 16px; background: white; border-top: 1px solid #ddd;
      display: flex; gap: 8px; flex-shrink: 0;
    }
    
    button {
      flex: 1; padding: 10px; border: none; border-radius: 6px; 
      font-weight: 600; cursor: pointer; font-size: 12px;
    }
    .btn-secondary { background: #E5F4FF; color: #0077C8; }
    .btn-secondary:hover { background: #CCE9FF; }
    .btn-purple { background: #9747FF; color: white; }
    .btn-purple:hover { background: #8433EA; }
    button:disabled { background: #ccc; color: #fff; cursor: default; }

    /* Detail View Styles */
    .detail-header { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    /* .back-btn { background: none; border: none; font-size: 16px; cursor: pointer; padding: 4px; color: #666; } */
    
    .detail-placeholder { color: #999; text-align: center; margin-top: 40%; font-size: 13px; }

    .section { background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
    .section-title { font-weight: 600; margin-bottom: 8px; font-size: 12px; color: #555; display: flex; justify-content: space-between; }
    
    .source-text { font-size: 14px; font-weight: 500; margin-bottom: 12px; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; }

    .match-item { padding: 8px; background: #f9f9f9; border-radius: 4px; margin-bottom: 6px; font-size: 12px; }
    .match-key { color: #888; font-size: 10px; margin-bottom: 2px; }
    .match-val { color: #333; font-weight: 500; }
    .match-tag { font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 4px; }
    .tag-exact { background: #d1fae5; color: #065f46; }
    .tag-pattern { background: #e0e7ff; color: #3730a3; }
    .tag-partial { background: #fff7ed; color: #9a3412; }

    .api-key-input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; }
    .translate-btn { width: 100%; background: #222; color: white; }
    .translate-btn:hover { background: #000; }

    .suggestion { margin-top: 12px; border-top: 1px solid #eee; padding-top: 8px; }
    .lang-title { font-weight: 600; color: #0077C8; margin-bottom: 4px; font-size: 12px; }
    .trans-option { margin-bottom: 8px; padding-left: 8px; border-left: 2px solid #ddd; }
    .trans-text { font-weight: 500; color: #333; }
    .trans-nuance { font-size: 11px; color: #666; margin-top: 2px; }
    .recommendation { margin-top: 12px; padding: 8px; background: #f0fdf4; border-radius: 4px; color: #166534; font-size: 12px; }

    .loading { text-align: center; color: #999; padding: 20px; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal { background: white; padding: 16px; border-radius: 8px; width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .modal h4 { margin: 0 0 12px 0; font-size: 14px; color: #333; }
    .modal input { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; }
    .modal-footer button { padding: 6px 12px; font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANEL -->
    <div class="panel-left">
      <!-- EXTRACT VIEW -->
      <div id="extractView" style="display:flex; flex-direction:column; height:100%;">
        <div class="header">
          <div style="display:flex; align-items:center; gap:8px;">
            <h3>ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h3>
            <span id="count" class="badge">0ê°œ</span>
            <button id="btnAdd" title="í˜„ì¬ ì„ íƒëœ í…ìŠ¤íŠ¸ ì¶”ê°€ (Cmd+Enter)" style="padding: 2px 6px; width:auto; background:none; border:1px solid #ddd; color:#0077C8; font-weight:bold;">+</button>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <label style="font-size:11px; display:flex; align-items:center; gap:2px; color:#666; cursor:pointer;" title="ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ëª©ë¡ ê°±ì‹ ">
              <input type="checkbox" id="chkAuto"> Auto
            </label>
            <button id="btnSettings" title="ì„¤ì • (API Key)" style="padding: 2px 6px; width:auto; background:none; border:1px solid #ddd; color:#666;">âš™ï¸</button>
            <button id="btnClear" title="ëª©ë¡ ì´ˆê¸°í™”" style="padding: 2px 6px; width:auto; background:none; border:1px solid #ddd; color:#666;">ğŸ—‘ï¸</button>
          </div>
        </div>
        
        <div id="list" class="list">
          <div class="empty">í”„ë ˆì„ì´ë‚˜ ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”.</div>
        </div>

        <div class="footer">
          <button id="btnCopy" class="btn-secondary" disabled>ë³µì‚¬</button>
          <button id="btnBatch" class="btn-secondary" style="background:#FFF0F5; color:#C2185B;" disabled>ì¼ê´„ ë²ˆì—­</button>
          <button id="btnMergeAction" class="btn-purple" disabled>ì„ íƒ í•­ëª© í•©ì¹˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="detailView" class="panel-right">
      <div id="detailPlaceholder" class="detail-placeholder">
        ì™¼ìª½ ëª©ë¡ì—ì„œ í…ìŠ¤íŠ¸ì˜ <strong>T</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ê±°ë‚˜,<br>
        ì²´í¬ë°•ìŠ¤ ì„ íƒ í›„ <strong>ì¼ê´„ ë²ˆì—­</strong>ì„ ì´ìš©í•˜ì„¸ìš”.
      </div>

      <!-- Single Detail View -->
      <div id="detailContent" style="display:none;">
        <div class="detail-header">
          <h3>ë²ˆì—­ & ë¦¬ì†ŒìŠ¤ í™•ì¸</h3>
        </div>
        
        <div class="source-text" id="detailSourceText"></div>

        <div class="section">
          <div class="section-title">ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰ ê²°ê³¼</div>
          <div id="resourceMatches">
            <div class="loading">ê²€ìƒ‰ ì¤‘...</div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Context (AI ë²ˆì—­ ì°¸ê³ ìš©)</div>
          <textarea id="contextInput" style="width:100%; height:60px; border:1px solid #ddd; border-radius:4px; padding:8px; box-sizing:border-box; font-family:inherit; resize:vertical;" placeholder="ë²ˆì—­ ì‹œ ì°¸ê³ í•  ìƒí™© ì„¤ëª…ì´ë‚˜ ë¬¸ë§¥ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ë¡œê·¸ì¸ í™”ë©´ì˜ ì—ëŸ¬ ë©”ì‹œì§€)"></textarea>
        </div>

        <div class="section">
          <div class="section-title">
            AI ë²ˆì—­ ì œì•ˆ (OpenAI)
            <button id="btnSetKey" style="width: auto; padding: 2px 6px; font-size: 10px; background: none; color: #999; border: 1px solid #eee;">API Key ì„¤ì •</button>
          </div>
          <!-- Inline API Key Section Removed -> Use Modal -->
          
          <div id="translationResult"></div>
          <button id="btnTranslate" class="translate-btn">AI ë²ˆì—­ ì‹¤í–‰</button>
        </div>
      </div>

      <!-- Batch View -->
      <div id="batchView" style="display:none;">
        <div class="detail-header">
          <h3>ì¼ê´„ AI ë²ˆì—­ (ì„ íƒëœ í•­ëª©)</h3>
        </div>

        <div class="section">
           <div class="section-title">ì„ íƒëœ í…ìŠ¤íŠ¸ ëª©ë¡ (<span id="batchCount">0</span>ê°œ)</div>
           <div id="batchList" style="max-height: 150px; overflow-y: auto; background: #fafafa; border: 1px solid #eee; padding: 8px; border-radius: 4px; font-size: 11px; color: #555;"></div>
        </div>

        <div class="section">
          <div class="section-title">Context (ê³µí†µ ì ìš©)</div>
          <textarea id="batchContextInput" style="width:100%; height:60px; border:1px solid #ddd; border-radius:4px; padding:8px; box-sizing:border-box; font-family:inherit; resize:vertical;" placeholder="ë²ˆì—­ ì‹œ ì°¸ê³ í•  ìƒí™© ì„¤ëª…ì´ë‚˜ ë¬¸ë§¥ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ë¡œê·¸ì¸ í™”ë©´ì˜ ì—ëŸ¬ ë©”ì‹œì§€)"></textarea>
        </div>

        <div class="section">
          <div class="section-title">
            AI ë²ˆì—­ ì‹¤í–‰ (OpenAI)
            <button id="btnSetKeyBatch" style="width: auto; padding: 2px 6px; font-size: 10px; background: none; color: #999; border: 1px solid #eee;">API Key ì„¤ì •</button>
          </div>
          
          <div id="batchResult"></div>
          <button id="btnBatchRun" class="translate-btn">ì¼ê´„ ë²ˆì—­ ì‹¤í–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- API Key Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal">
      <h4>OpenAI API Key ì„¤ì •</h4>
      <input type="password" id="modalApiKeyInput" placeholder="sk-...">
      <div style="font-size: 11px; color: #666; margin-bottom: 12px; line-height: 1.4;">
        OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
        í‚¤ëŠ” ë¸Œë¼ìš°ì € ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
      </div>
      <div class="modal-footer">
        <button id="btnCancelKey" style="background: #eee; color: #333;">ì·¨ì†Œ</button>
        <button id="btnSaveKey" class="btn-purple">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    let currentData = [];
    let currentDetailItem = null;
    let currentDetailMatches = [];
    let batchResults = null; // ë²ˆì—­ ê²°ê³¼ ì €ì¥ìš©

    // TODO: ì½”ë“œì— API Keyë¥¼ ì§ì ‘ ë„£ìœ¼ë ¤ë©´ ì•„ë˜ ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    let apiKey = '';

    try {
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ í‚¤ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      const storedKey = localStorage.getItem('openai_api_key');
      if (storedKey) apiKey = storedKey;
    } catch(e) {}

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'selection-update') {
        // Check Auto-Sync
        const isAuto = document.getElementById('chkAuto').checked;
        if (!isAuto) return; // Ignore updates if Auto is off

        const newData = msg.data;
        // Update list to reflect current selection (Replace)
        
        const existingMap = new Map(currentData.map(d => [d.ids.join(','), d]));
        currentData = newData.map(d => {
             const key = d.ids.join(',');
             if (existingMap.has(key)) {
               const existing = existingMap.get(key);
               return { ...d, checked: existing.checked, mergeSelected: existing.mergeSelected, originalItems: existing.originalItems };
             }
             return { ...d, checked: true, mergeSelected: false, originalItems: null };
        });

        render();
        saveState();
      }

      if (msg.type === 'add-items') {
        const newData = msg.data;
        const existingMap = new Map(currentData.map(d => [d.ids.join(','), d]));
        let added = false;
        
        newData.forEach(d => {
           const key = d.ids.join(',');
           if (!existingMap.has(key)) {
             currentData.push({ ...d, checked: true, mergeSelected: false, originalItems: null });
             added = true;
           }
        });
        
        if (added) {
          render();
          saveState();
        }
      }

      if (msg.type === 'restore-state') {
        if (msg.data && Array.isArray(msg.data)) {
           const existingMap = new Map(currentData.map(d => [d.ids.join(','), d]));
           msg.data.forEach(item => {
             const key = item.ids.join(',');
             if (!existingMap.has(key)) {
               currentData.push(item);
             }
           });
           render();
        }
      }

      if (msg.type === 'translation-check-result') {
        currentDetailMatches = msg.data || [];
        renderResourceMatches(msg.data, msg.originalText);
      }

      if (msg.type === 'batch-translation-check-result') {
        runBatchOpenAI(msg.data);
      }

      if (msg.type === 'restore-batch-results') {
        batchResults = msg.data;
        // ë§Œì•½ í˜„ì¬ ë°°ì¹˜ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ë°”ë¡œ ë Œë”ë§
        if (document.getElementById('batchView').style.display === 'block') {
           renderBatchResults(batchResults);
        }
      }

      if (msg.type === 'restore-batch-context') {
        batchContext = msg.data || '';
        document.getElementById('batchContextInput').value = batchContext;
      }
    };

    window.addEventListener('keydown', (e) => {
      // Shortcut to add current selection: Shift + A or similar?
      // But focus is usually on Canvas. This works only if UI is focused.
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        // Cmd+Enter to Add Selection?
        parent.postMessage({ pluginMessage: { type: 'add-selection' } }, '*');
      }
    });

    function render() {
      const list = document.getElementById('list');
      list.innerHTML = '';
      
      const checkedCount = currentData.filter(d => d.checked).length;
      document.getElementById('count').innerText = `${checkedCount} / ${currentData.length}`;
      
      const btns = document.querySelectorAll('#listView button:not(.action-btn):not(#btnClear)');
      if (currentData.length === 0) {
        list.innerHTML = `<div class="empty">í”„ë ˆì„ì´ë‚˜ ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”.</div>`;
        btns.forEach(b => b.disabled = true);
        return;
      }
      
      document.getElementById('btnCopy').disabled = checkedCount === 0;
      document.getElementById('btnBatch').disabled = checkedCount === 0;

      const mergeCount = currentData.filter(d => d.mergeSelected).length;
      const mergeBtn = document.getElementById('btnMergeAction');
      mergeBtn.disabled = mergeCount < 2;
      mergeBtn.innerText = mergeCount > 0 ? `${mergeCount}ê°œ í•©ì¹˜ê¸°` : "ì„ íƒ í•­ëª© í•©ì¹˜ê¸°";

      currentData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `item ${item.checked ? '' : 'excluded'} ${item.mergeSelected ? 'merge-selected' : ''}`;
        
        const isMerged = !!item.originalItems;
        
        div.innerHTML = `
          <div class="checkbox-wrapper" title="ì¶”ì¶œ ì œì™¸">
            <input type="checkbox" ${item.checked ? 'checked' : ''}>
          </div>
          <div class="content-wrapper">
            ${isMerged ? '<span class="merged-badge" title="í´ë¦­í•˜ì—¬ ë³‘í•© í•´ì œ">MERGED <span class="close-icon">âœ•</span></span>' : ''}
            <div class="content">${escapeHtml(item.text)}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:2px;">
             <div class="action-btn translate-icon" title="ë²ˆì—­ ë° í™•ì¸">T</div>
          </div>
          <div class="action-btn merge-btn" title="ë³‘í•© ëŒ€ìƒìœ¼ë¡œ ì„ íƒ">
            ${item.mergeSelected ? 'âœ“' : '+'}
          </div>
        `;
        
        div.querySelector('input').onchange = (e) => {
          const isChecked = e.target.checked;
          
          if (!isChecked) {
            // ì²´í¬ í•´ì œ ì‹œ -> ëª©ë¡ì—ì„œ ì œê±° + í•˜ì´ë¼ì´íŠ¸ ì œê±°
            const idx = currentData.indexOf(item);
            if (idx > -1) {
              currentData.splice(idx, 1);
            }
            // í•˜ì´ë¼ì´íŠ¸ ì œê±° ë©”ì‹œì§€ ì „ì†¡
            parent.postMessage({ pluginMessage: { type: 'clear-highlights', ids: item.ids } }, '*');
          } else {
            item.checked = true;
          }
          
          render();
          saveState();
        };
        
        div.querySelector('.content-wrapper').onclick = (e) => {
          if (e.target.closest('.merged-badge')) return;
          focusNodes(item.ids);
        };

        const badge = div.querySelector('.merged-badge');
        if (badge) {
          badge.onclick = (e) => {
            e.stopPropagation();
            unmergeItem(index);
          };
        }
        
        // Translate Button (T icon)
        const transIcon = div.querySelector('.translate-icon');
        if (transIcon) {
          transIcon.onclick = (e) => {
            e.stopPropagation();
            openDetail(item);
          };
        }

        div.querySelector('.merge-btn').onclick = (e) => {
          e.stopPropagation();
          item.mergeSelected = !item.mergeSelected;
          render();
          saveState();
        };

        list.appendChild(div);
      });
    }
    // --- Persistence ---
    function saveState() {
      parent.postMessage({ pluginMessage: { type: 'save-state', data: currentData } }, '*');
    }

    document.getElementById('btnClear').onclick = () => {
      if (confirm('ëª©ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        currentData = [];
        batchResults = null; // ë°°ì¹˜ ê²°ê³¼ë„ ì´ˆê¸°í™”
        batchContext = ''; // Contextë„ ì´ˆê¸°í™”
        document.getElementById('batchContextInput').value = '';
        
        parent.postMessage({ pluginMessage: { type: 'save-batch-results', data: null } }, '*');
        parent.postMessage({ pluginMessage: { type: 'save-batch-context', data: '' } }, '*');
        parent.postMessage({ pluginMessage: { type: 'save-state', data: [] } }, '*'); // ëª©ë¡ ìƒíƒœ ì´ˆê¸°í™” ì €ì¥
        parent.postMessage({ pluginMessage: { type: 'clear-highlights' } }, '*'); // ìº”ë²„ìŠ¤ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        
        render();
        // saveState(); -> ìœ„ì—ì„œ ì´ë¯¸ save-state ë³´ëƒ„
      }
    };

    document.getElementById('btnAdd').onclick = () => {
       parent.postMessage({ pluginMessage: { type: 'add-selection' } }, '*');
    };


    function openDetail(item) {
      currentDetailItem = item;
      currentDetailMatches = [];
      
      // Update Detail UI
      document.getElementById('detailPlaceholder').style.display = 'none';
      document.getElementById('batchView').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';
      
      document.getElementById('detailSourceText').innerText = item.text;
      document.getElementById('resourceMatches').innerHTML = '<div class="loading">ê²€ìƒ‰ ì¤‘...</div>';
      document.getElementById('translationResult').innerHTML = '';
      
      // Request matches from code.ts
      parent.postMessage({ pluginMessage: { type: 'check-translation', text: item.text } }, '*');
    }

    function renderResourceMatches(matches, originalText) {
      const container = document.getElementById('resourceMatches');
      if (!matches || matches.length === 0) {
        container.innerHTML = '<div class="match-item" style="color:#888;">ì¼ì¹˜í•˜ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      container.innerHTML = matches.map(m => {
        let tagClass = 'tag-partial';
        if (m.type === 'EXACT') tagClass = 'tag-exact';
        if (m.type === 'PATTERN_MATCH') tagClass = 'tag-pattern';
        
        return `
        <div class="match-item">
          <div class="match-key">${m.key} <span class="match-tag ${tagClass}">${m.type}</span></div>
          <div class="match-val" style="background: #e3f2fd; color: #0d47a1; padding: 4px 6px; border-radius: 4px; font-weight: 700; margin-bottom: 4px;">ğŸ‡ºğŸ‡¸ ${escapeHtml(m.value)}</div>
          ${m.deValue ? `<div class="match-val" style="margin-top:2px; color:#555;">ğŸ‡©ğŸ‡ª ${escapeHtml(m.deValue)}</div>` : ''}
          ${m.frValue ? `<div class="match-val" style="margin-top:2px; color:#555;">ğŸ‡«ğŸ‡· ${escapeHtml(m.frValue)}</div>` : ''}
        </div>
      `}).join('');
    }

    // --- Batch View Logic ---
    
    // Context ì…ë ¥ ì‹œ ìë™ ì €ì¥ (Debounce ì—†ì´ ê°„ë‹¨í•˜ê²Œ change ì´ë²¤íŠ¸ë‚˜ blur ì‚¬ìš©)
    document.getElementById('batchContextInput').addEventListener('input', (e) => {
      const val = e.target.value;
      batchContext = val;
      parent.postMessage({ pluginMessage: { type: 'save-batch-context', data: val } }, '*');
    });

    document.getElementById('btnBatch').onclick = () => {
       const selectedItems = currentData.filter(d => d.checked);
       if (selectedItems.length === 0) return;

       document.getElementById('detailPlaceholder').style.display = 'none';
       document.getElementById('detailContent').style.display = 'none';
       document.getElementById('batchView').style.display = 'block';

       document.getElementById('batchCount').innerText = selectedItems.length;
       
       const listEl = document.getElementById('batchList');
       listEl.innerHTML = selectedItems.map(item => `
         <div style="margin-bottom:4px; border-bottom:1px solid #eee; padding-bottom:2px;">
           ${escapeHtml(item.text)}
         </div>
       `).join('');
       
       document.getElementById('batchResult').innerHTML = '';

       // ì €ì¥ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë³µì›
       if (batchResults) {
         renderBatchResults(batchResults);
       }
    };

    document.getElementById('btnSetKeyBatch').onclick = () => {
        document.getElementById('btnSetKey').click(); // Reuse existing
    };

    document.getElementById('btnBatchRun').onclick = () => {
        const selectedItems = currentData.filter(d => d.checked);
        if (selectedItems.length === 0) return;
        
        if (!apiKey) {
            alert('OpenAI API Keyë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
            return;
        }

        const btn = document.getElementById('btnBatchRun');
        btn.disabled = true;
        btn.innerText = 'ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰ ë° ë²ˆì—­ ì¤‘...';
        document.getElementById('batchResult').innerHTML = '<div class="loading">ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰ ì¤‘...</div>';

        // 1. Request matches for all items
        parent.postMessage({ pluginMessage: { type: 'check-batch-translation', items: selectedItems } }, '*');
    };

    async function runBatchOpenAI(itemsWithMatches) {
        const btn = document.getElementById('btnBatchRun');
        const resultArea = document.getElementById('batchResult');
        const context = document.getElementById('batchContextInput').value.trim();

        try {
            resultArea.innerHTML = '<div class="loading">OpenAI ë²ˆì—­ ìš”ì²­ ì¤‘...</div>';

            // Construct Prompt
            const itemsPrompt = itemsWithMatches.map((item, idx) => {
                let refText = "";
                if (item.matches && item.matches.length > 0) {
                     refText = "   Matches: " + item.matches.map(m => {
                         const parts = [`"${m.value}"`];
                         if (m.deValue) parts.push(`DE: "${m.deValue}"`);
                         if (m.frValue) parts.push(`FR: "${m.frValue}"`);
                         return `[${parts.join(', ')}]`;
                     }).join(", ");
                }
                return `Item ${idx + 1}: "${item.text}"${refText ? '\n' + refText : ''}`;
            }).join('\n\n');

            const prompt = `
              Translate the following list of UI texts into French (fr) and German (de).
              Context: Mobile app/webtoon platform (Tappytoon).
              ${context ? `User Context: ${context}` : ''}
              
              Each item may have "Matches" listed below it. These are existing similar translations in our database. Use them as a reference for consistency, but prioritize the User Context if it differs.

              List of items to translate:
              ${itemsPrompt}
              
              Output JSON format:
              {
                "results": [
                  {
                    "original": "Original Text",
                    "fr": [ { "text": "...", "nuance": "..." }, ... ],
                    "de": [ { "text": "...", "nuance": "..." }, ... ],
                    "recommendation": "Brief reason"
                  },
                  ...
                ]
              }
              Ensure the order matches the input list.
            `;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" }
              })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const content = JSON.parse(data.choices[0].message.content);
            
            // ê²°ê³¼ ì €ì¥ ë° ë Œë”ë§
            batchResults = content.results;
            parent.postMessage({ pluginMessage: { type: 'save-batch-results', data: batchResults } }, '*');
            
            renderBatchResults(content.results);

        } catch (err) {
            resultArea.innerHTML = `<div style="color:red; padding:10px;">Error: ${err.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = 'ì¼ê´„ ë²ˆì—­ ì‹¤í–‰';
        }
    }

    function renderBatchResults(results) {
        const container = document.getElementById('batchResult');
        if (!results || !Array.isArray(results)) {
            container.innerHTML = '<div style="padding:10px;">ê²°ê³¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '';
        results.forEach((res, idx) => {
             html += `<div class="section" style="border-left: 3px solid #0077C8;">
               <div style="font-weight:600; margin-bottom:8px; font-size:13px;">${idx+1}. ${escapeHtml(res.original)}</div>`;
             
             ['fr', 'de'].forEach(lang => {
                const langName = lang === 'fr' ? 'ğŸ‡«ğŸ‡· French' : 'ğŸ‡©ğŸ‡ª German';
                const options = res[lang];
                html += `<div style="margin-top:6px;"><div style="font-size:11px; font-weight:bold; color:#555;">${langName}</div>`;
                if (Array.isArray(options)) {
                   options.forEach(opt => {
                       html += `<div class="trans-option" style="margin-bottom:4px;"><div class="trans-text" style="font-size:12px;">${escapeHtml(opt.text)}</div><div class="trans-nuance" style="font-size:10px;">${escapeHtml(opt.nuance)}</div></div>`;
                   });
                }
                html += `</div>`;
             });
             
             if (res.recommendation) {
                 html += `<div class="recommendation" style="font-size:11px; margin-top:6px;">ğŸ’¡ ${escapeHtml(res.recommendation)}</div>`;
             }
             html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    // --- OpenAI Translation Logic ---

    // Open Modal Handlers
    function openSettingsModal() {
      document.getElementById('modalApiKeyInput').value = apiKey;
      document.getElementById('settingsModal').style.display = 'flex';
      document.getElementById('modalApiKeyInput').focus();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    document.getElementById('btnSettings').onclick = openSettingsModal;
    document.getElementById('btnSetKey').onclick = openSettingsModal;

    document.getElementById('btnCancelKey').onclick = closeSettingsModal;
    
    document.getElementById('btnSaveKey').onclick = () => {
      const input = document.getElementById('modalApiKeyInput');
      const newKey = input.value.trim();
      if (!newKey) {
        alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      apiKey = newKey;
      localStorage.setItem('openai_api_key', apiKey);
      closeSettingsModal();
      alert('API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    document.getElementById('btnTranslate').onclick = async () => {
      if (!apiKey) {
        openSettingsModal();
        // alert('OpenAI API Keyë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
        return;
      }

      const btn = document.getElementById('btnTranslate');
      const resultArea = document.getElementById('translationResult');
      
      btn.disabled = true;
      btn.innerText = 'ë²ˆì—­ ì¤‘...';
      resultArea.innerHTML = '';

      try {
        const text = currentDetailItem.text;
        const context = document.getElementById('contextInput').value.trim();
        
        let referenceText = "";
        if (currentDetailMatches && currentDetailMatches.length > 0) {
           referenceText = "\nExisting Resources (Reference):\n" + currentDetailMatches.map(m => {
             const parts = [`Key: ${m.key}`, `EN: "${m.value}"`];
             if (m.deValue) parts.push(`DE: "${m.deValue}"`);
             if (m.frValue) parts.push(`FR: "${m.frValue}"`);
             return "- " + parts.join(", ");
           }).join("\n");
        }

        const prompt = `
          Translate the following text into French (fr) and German (de).
          Context: Mobile app/webtoon platform (Tappytoon).
          ${context ? `User Context: ${context}` : ''}
          ${referenceText}
          
          Source Text: "${text}"
          
          Requirements:
          1. Provide 3 options for each language.
          2. Explain the nuance for each option briefly.
          3. Recommend the best option.
          
          Output JSON format:
          {
            "fr": [ { "text": "...", "nuance": "..." }, ... ],
            "de": [ { "text": "...", "nuance": "..." }, ... ],
            "recommendation": "Explain which option is best and why."
          }
        `;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            response_format: { type: "json_object" }
          })
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }

        const content = JSON.parse(data.choices[0].message.content);
        renderTranslationResult(content);

      } catch (err) {
        resultArea.innerHTML = `<div style="color:red; padding:10px;">Error: ${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.innerText = 'AI ë²ˆì—­ ì‹¤í–‰';
      }
    };

    function renderTranslationResult(data) {
      const container = document.getElementById('translationResult');
      let html = '';

      ['fr', 'de'].forEach(lang => {
        const langName = lang === 'fr' ? 'French ğŸ‡«ğŸ‡·' : 'German ğŸ‡©ğŸ‡ª';
        const options = data[lang];
        html += `<div class="suggestion"><div class="lang-title">${langName}</div>`;
        if (Array.isArray(options)) {
          options.forEach(opt => {
            html += `
              <div class="trans-option">
                <div class="trans-text">${escapeHtml(opt.text)}</div>
                <div class="trans-nuance">${escapeHtml(opt.nuance)}</div>
              </div>
            `;
          });
        }
        html += `</div>`;
      });

      if (data.recommendation) {
        html += `<div class="recommendation"><strong>Recommendation:</strong><br>${escapeHtml(data.recommendation)}</div>`;
      }

      container.innerHTML = html;
    }

    // --- Existing Helper Functions ---

    function unmergeItem(index) {
      const item = currentData[index];
      if (!item.originalItems) return;
      const restoredItems = item.originalItems.map(original => ({
        ...original,
        checked: true,
        mergeSelected: false
      }));
      currentData.splice(index, 1, ...restoredItems);
      render();
      updateCanvasSelection();
    }

    function updateCanvasSelection() {
      const allCheckedIds = currentData
        .filter(d => d.checked)
        .flatMap(d => d.ids);
      parent.postMessage({ pluginMessage: { type: 'update-selection', ids: allCheckedIds } }, '*');
    }

    function focusNodes(ids) {
      parent.postMessage({ pluginMessage: { type: 'focus-nodes', ids: ids } }, '*');
    }

    document.getElementById('btnMergeAction').onclick = () => {
      const selectedItems = currentData.filter(d => d.mergeSelected);
      if (selectedItems.length < 2) return;

      const newText = selectedItems.map(d => d.text).join(' ');
      const newIds = selectedItems.flatMap(d => d.ids);

      const newItem = {
        ids: newIds,
        text: newText,
        checked: true,
        mergeSelected: false,
        originalItems: selectedItems
      };

      const firstMergeIndex = currentData.findIndex(d => d.mergeSelected);
      const newData = [];
      
      currentData.forEach((item, index) => {
        if (index === firstMergeIndex) {
          newData.push(newItem);
        } 
        if (!item.mergeSelected) {
           if (index !== firstMergeIndex) newData.push(item);
        }
      });
      
      currentData = newData;
      render();
      updateCanvasSelection();
    };

    document.getElementById('btnCopy').onclick = () => {
      const text = currentData.filter(d => d.checked).map(d => d.text).join('\n');
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      
      const btn = document.getElementById('btnCopy');
      const original = btn.innerText;
      btn.innerText = "ì™„ë£Œ!";
      setTimeout(() => btn.innerText = original, 1000);
    };

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
