<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <style>
    :root {
      /* Colors */
      --primary-color: #18A0FB;
      --primary-hover: #0D8CE0;
      --purple-color: #7B61FF;
      --purple-hover: #674CE5;
      --success-color: #1BC47D;
      --warning-color: #F2994A;
      --danger-color: #F24822;
      
      --text-main: #333333;
      --text-sub: #8e8e8e;
      --text-on-primary: #ffffff;

      --bg-main: #ffffff;
      --bg-sub: #F9F9F9;
      --bg-hover: #F0F0F0;
      
      --border-color: #E6E6E6;
      --border-focus: #18A0FB;

      --radius-sm: 2px;
      --radius-md: 4px;
      
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      font-family: var(--font-family);
      font-size: 12px;
      color: var(--text-main);
      margin: 0;
      background: var(--bg-main);
      line-height: 1.5;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #E6E6E6; border-radius: 4px; border: 2px solid var(--bg-main); }
    ::-webkit-scrollbar-thumb:hover { background: #D1D1D1; }

    /* Layout */
    .container { display: flex; height: 100vh; overflow: hidden; }

    /* Panels */
    .panel-left {
      width: 320px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      background: var(--bg-sub);
      flex-shrink: 0;
    }
    .panel-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-main);
      overflow-y: auto;
      padding: 24px 32px;
    }

    /* Header & Tabs */
    .header {
      padding: 12px 16px;
      background: var(--bg-sub);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .header-top {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
    }
    h3 { margin: 0; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

    .tabs { display: flex; gap: 4px; background: #E6E6E6; padding: 2px; border-radius: 4px; }
    .tab {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 3px;
      color: var(--text-sub);
      transition: all 0.1s;
    }
    .tab:hover { color: var(--text-main); }
    .tab.active { background: white; color: var(--primary-color); font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    .tab-badge { display: inline-block; background: rgba(0,0,0,0.1); border-radius: 8px; padding: 0 5px; font-size: 9px; margin-left: 4px; }
    .tab.active .tab-badge { background: var(--primary-color); color: white; }

    /* Buttons - Base */
    button {
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    button:disabled { opacity: 0.4; cursor: default !important; }
    button:focus { outline: none; }

    /* Icon Button */
    .icon-btn { 
      width: 28px; height: 28px; 
      background: transparent; 
      color: var(--text-sub); 
      border-radius: var(--radius-md); 
    }
    .icon-btn:hover:not(:disabled) { background: rgba(0,0,0,0.06); color: var(--text-main); }

    /* Primary Button */
    .btn-primary { 
      background: var(--primary-color); 
      color: white; 
      font-weight: 600; 
      padding: 8px 16px; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .btn-primary:hover:not(:disabled) { 
      background: var(--primary-hover); 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    /* Secondary Button */
    .btn-secondary { 
      background: white; 
      color: var(--text-main); 
      border: 1px solid var(--border-color); 
      font-weight: 500; 
      padding: 8px 16px; 
    }
    .btn-secondary:hover:not(:disabled) { 
      background: #fafafa; 
      border-color: #ccc; 
    }

    /* Danger Button */
    .btn-danger {
      background: white;
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
      padding: 8px 16px;
    }
    .btn-danger:hover:not(:disabled) {
      background: #FEF2F2;
    }

    /* Approve Button */
    .btn-approve {
      background: white;
      color: var(--purple-color);
      border: 1px solid var(--purple-color);
      padding: 8px 16px;
      font-weight: 600;
    }
    .btn-approve:hover:not(:disabled) {
      background: #F5F3FF;
    }
    .btn-approve.approved {
      background: #F3F4F6;
      color: #9CA3AF;
      border-color: #E5E7EB;
      cursor: default;
    }

    /* Slack Button */
    .btn-slack { 
      background: #4A154B; 
      color: white; 
      padding: 10px 16px; 
      width: 100%; 
      border-radius: var(--radius-md); 
      font-weight: 600; 
      font-size: 12px; 
    }
    .btn-slack:hover:not(:disabled) { 
      background: #611f69; 
    }

    /* Small Button Modifier */
    .btn-sm {
      padding: 6px 10px;
      font-size: 11px;
    }

    /* List */
    .list { padding: 8px; display: flex; flex-direction: column; gap: 4px; flex: 1; overflow-y: auto; }
    .empty { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); text-align: center; font-size: 13px; gap: 8px; }

    .item {
      display: flex; gap: 8px; align-items: center;
      background: white; padding: 8px 10px; border-radius: var(--radius-sm);
      border: 1px solid transparent; cursor: pointer;
      transition: background 0.1s;
    }
    .item:hover { background: var(--bg-hover); }
    .item.active { background: #F0F9FF; border-color: #BAE6FD; }
    
    .status-indicator { width: 6px; height: 6px; border-radius: 50%; background: #ccc; flex-shrink: 0; }
    .status-draft { background: #ccc; }
    .status-review { background: var(--warning-color); }
    .status-done { background: var(--success-color); }

    .item-content { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-meta { font-size: 10px; color: var(--text-sub); margin-top: 2px; }

    /* Footer */
    .footer { padding: 12px; border-top: 1px solid var(--border-color); background: white; }

    /* Detail View */
    .detail-placeholder { 
      text-align: center; 
      margin: auto; 
      color: var(--text-sub); 
      font-size: 13px;
      padding: 40px;
    }
    .detail-placeholder::before {
      content: "üìÑ";
      display: block;
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .detail-header { 
      background: linear-gradient(to bottom, #F9FAFB, transparent);
      border-bottom: 1px solid var(--border-color); 
      padding-bottom: 20px; 
      margin: -24px -32px 24px -32px;
      padding: 20px 32px;
    }
    .detail-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .detail-header-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .detail-header-actions {
      display: flex;
      gap: 8px;
    }
    .detail-id {
      font-size: 11px;
      color: var(--text-sub);
      font-family: 'SF Mono', Monaco, monospace;
      background: #F3F4F6;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    /* Status Badge */
    .status-badge { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 12px; 
      font-size: 10px; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.05em;
    }
    .badge-draft { background: #F3F4F6; color: #6B7280; }
    .badge-review { background: #FFF7ED; color: #C2410C; }
    .badge-done { background: #ECFDF5; color: #047857; }

    /* Sections */
    .section { margin-bottom: 24px; }
    .section-label { 
      font-size: 11px; 
      font-weight: 600; 
      color: var(--text-sub); 
      text-transform: uppercase; 
      margin-bottom: 10px; 
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Translation Panel - Major sections with card styling */
    .translation-panel {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .translation-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: #F8FAFC;
      border-bottom: 1px solid var(--border-color);
    }
    .translation-panel-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }
    .translation-panel-body {
      padding: 16px;
    }
    
    /* Section Card - for grouped content */
    .section-card {
      background: #FAFAFA;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
    }
    
    .text-box { 
      padding: 14px 16px; 
      background: #FAFAFA; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-md); 
      font-size: 14px; 
      line-height: 1.6; 
      white-space: pre-wrap;
      color: var(--text-main);
    }

    /* Option Cards (AI Drafts) */
    .option-card {
      padding: 14px; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-md);
      margin-bottom: 8px; 
      cursor: pointer; 
      transition: all 0.15s ease; 
      background: white;
    }
    .option-card:hover { 
      border-color: #bbb; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    .option-card.selected { 
      border-color: var(--primary-color); 
      background: #F0F9FF; 
      box-shadow: 0 0 0 3px rgba(24, 160, 251, 0.1);
    }
    .option-card-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 4px;
    }
    .option-card-nuance {
      font-size: 11px;
      color: var(--text-sub);
    }
    
    /* Language Columns */
    .lang-row { display: flex; gap: 20px; }
    .lang-col { flex: 1; }
    .lang-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Actions Footer */
    .detail-actions {
      margin-top: 32px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Inputs */
    textarea.edit-field {
      width: 100%; 
      min-height: 40px; 
      max-height: 200px;
      padding: 10px 12px; 
      box-sizing: border-box;
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-md);
      font-family: inherit; 
      font-size: 13px;
      line-height: 1.5;
      resize: none;
      overflow-y: hidden;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    textarea.edit-field:focus { 
      outline: none; 
      border-color: var(--primary-color); 
      box-shadow: 0 0 0 3px rgba(24, 160, 251, 0.1);
    }
    textarea.edit-field::placeholder {
      color: #bbb;
    }

    /* Task Groups */
    .task-group {
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: white;
    }
    .task-header {
      padding: 6px 10px;
      background: #F3F4F6;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 10px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .task-items {
      padding: 2px;
    }

    /* Apply Button */
    .btn-apply {
      width: 100%;
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: white;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .btn-apply:hover {
      background: #F5F5F5;
      border-color: #bbb;
    }
    .btn-apply.active {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }
    .btn-apply.active:hover {
      background: #17a06d;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANEL: LIST -->
    <div class="panel-left">
      <div class="header">
        <div class="header-top">
          <h3>Translations</h3>
          <div style="display:flex; gap:4px;">
            <button id="btnAdd" class="icon-btn" title="Add Selected Text">+</button>
            <button id="btnClear" class="icon-btn" title="Clear All">üóë</button>
            <button id="btnSettings" class="icon-btn" title="Settings">‚öôÔ∏è</button>
          </div>
        </div>

        <!-- File Status Indicator -->
        <div id="fileStatus" style="padding: 6px 12px; margin: 8px 0; background: #FEF3C7; border-radius: 4px; font-size: 10px; display: none;">
          <span style="color: #92400E;">‚ö†Ô∏è File not saved to Figma Cloud. Slack links will not work.</span>
        </div>

        <!-- File Key Display -->
        <!-- <div id="fileKeyDisplay" style="padding: 6px 12px; margin: 8px 0; background: #ECFDF5; border-radius: 4px; font-size: 10px; display: none;">
          <div style="color: #047857; font-weight: 600; margin-bottom: 2px;">File Info:</div>
          <div style="color: #065F46; font-family: monospace;">Key: <span id="fileKeyText"></span></div>
          <div style="color: #065F46;">Name: <span id="fileNameText"></span></div>
        </div> -->

        <div class="tabs">
          <div class="tab active" data-tab="all">All <span id="badge-all" class="tab-badge">0</span></div>
          <div class="tab" data-tab="draft">Draft <span id="badge-draft" class="tab-badge">0</span></div>
          <div class="tab" data-tab="review">Review <span id="badge-review" class="tab-badge">0</span></div>
          <div class="tab" data-tab="done">Done <span id="badge-done" class="tab-badge">0</span></div>
        </div>
      </div>

      <div id="list" class="list">
        <!-- Items go here -->
      </div>

      <div class="footer">
        <!-- Contextual Actions based on Tab -->
        <button id="btnFooterAction" class="btn-slack" disabled>Send 0 items to Review</button>
      </div>
    </div>

    <!-- RIGHT PANEL: DETAIL -->
    <div id="detailView" class="panel-right">
      <div id="detailPlaceholder" class="detail-placeholder">
        Select an item to view details<br>or perform actions.
      </div>
      
      <div id="detailContent" style="display:none;">
        <!-- Header -->
        <div class="detail-header">
          <div class="detail-header-top">
             <div class="detail-header-info">
               <span id="detailStatusBadge" class="status-badge badge-draft">Draft</span>
               <span class="detail-id">ID: <span id="detailId"></span></span>
             </div>
             <div class="detail-header-actions">
               <button id="btnFocus" class="btn-secondary btn-sm">Focus</button>
               <button id="btnDeleteItem" class="btn-danger btn-sm">Remove</button>
             </div>
          </div>
        </div>

        <!-- 1. Source Text -->
        <div class="section">
          <div class="section-label">Source Text (English)</div>
          <div id="detailSource" class="text-box"></div>
        </div>

        <!-- 2. Glossary Matches -->
        <div class="section" id="glossarySection">
          <div class="section-label">Glossary Matches</div>
          <div id="glossaryMatches" class="section-card" style="font-size:12px;">Checking...</div>
        </div>

        <!-- 3. AI Drafts -->
        <div id="draftSection" class="translation-panel">
           <div class="translation-panel-header">
             <span class="translation-panel-title">AI Drafts</span>
             <button id="btnRegen" class="btn-secondary btn-sm">Generate</button>
           </div>
           <div class="translation-panel-body">
             <div class="lang-row">
               <div class="lang-col">
                 <div class="lang-label">üá´üá∑ French</div>
                 <div id="draftsFr"></div>
               </div>
               <div class="lang-col">
                 <div class="lang-label">üá©üá™ German</div>
                 <div id="draftsDe"></div>
               </div>
             </div>
           </div>
        </div>

        <!-- 4. Final Translation -->
        <div id="reviewSection" class="translation-panel" style="display:none;">
           <div class="translation-panel-header">
             <span class="translation-panel-title">Final Translation</span>
           </div>
           <div class="translation-panel-body">
             <div class="lang-row">
               <div class="lang-col">
                 <div class="lang-label">üá´üá∑ French</div>
                 <textarea id="editFr" class="edit-field" placeholder="Enter French translation..."></textarea>
                 <button id="btnApplyFr" class="btn-apply" data-lang="fr">Apply to Canvas</button>
               </div>
               <div class="lang-col">
                 <div class="lang-label">üá©üá™ German</div>
                 <textarea id="editDe" class="edit-field" placeholder="Enter German translation..."></textarea>
                 <button id="btnApplyDe" class="btn-apply" data-lang="de">Apply to Canvas</button>
               </div>
             </div>
           </div>
        </div>

        <!-- 5. Approve Actions -->
        <div class="detail-actions">
           <button id="btnApproveFr" class="btn-approve" style="display:none;">üá´üá∑ Approve French</button>
           <button id="btnApproveDe" class="btn-approve" style="display:none;">üá©üá™ Approve German</button>
        </div>

      </div>
    </div>
  </div>
  
  <!-- Hidden Settings Modal for API Key -->
  <div id="settingsModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:4px; width:400px;">
       <h4 style="margin-top:0;">Settings</h4>

       <label style="font-size:11px; font-weight:600; display:block; margin-bottom:4px;">OpenAI API Key</label>
       <input type="password" id="apiKeyInput" style="width:100%; padding:8px; margin-bottom:12px; box-sizing:border-box; border:1px solid #ddd; border-radius:3px;">

       <label style="font-size:11px; font-weight:600; display:block; margin-bottom:4px;">Slack Webhook URL</label>
       <input type="text" id="slackUrlInput" placeholder="https://hooks.slack.com/services/..." style="width:100%; padding:8px; margin-bottom:12px; box-sizing:border-box; border:1px solid #ddd; border-radius:3px;">

       <label style="font-size:11px; font-weight:600; display:block; margin-bottom:4px;">Figma File Key (Optional - for local dev)</label>
       <input type="text" id="fileKeyInput" placeholder="gx35mT7juVjHGfzW07EQ0w" style="width:100%; padding:8px; margin-bottom:4px; box-sizing:border-box; border:1px solid #ddd; border-radius:3px; font-family: monospace; font-size: 11px;">
       <div style="font-size:10px; color:#666; margin-bottom:12px;">Get from browser URL: figma.com/design/<strong>THIS_PART</strong>/filename</div>

       <div style="text-align:right; margin-top:8px;">
         <button id="btnSaveKey" class="btn-primary">Save</button>
         <button id="btnCloseKey" class="btn-secondary">Close</button>
       </div>
    </div>
  </div>

  <script>
    // --- Constants ---
    const STATUS = {
      DRAFT: 'Draft',
      IN_PROGRESS: 'Review',
      DONE: 'Done'
    };

    const REVIEW_STATUS = {
      PENDING: 'PENDING',
      REQUESTED: 'REQUESTED',
      APPROVED: 'APPROVED'
    };

    const TABS = {
      ALL: 'all',
      DRAFT: 'draft',
      REVIEW: 'review',
      DONE: 'done'
    };

    const LANGUAGES = {
      FR: 'fr',
      DE: 'de'
    };

    const OPENAI_CONFIG = {
      MODEL: 'gpt-4o',
      API_URL: 'https://api.openai.com/v1/chat/completions'
    };

    const FIGMA_URLS = {
      WEB: 'https://www.figma.com/design',
      DESKTOP: 'figma://file'
    };

    // --- State ---
    let items = []; // { id, text, status, reviews: {fr, de}, drafts: {fr:[], de:[]}, final: {fr, de} }
    let activeTab = TABS.ALL;
    let selectedItemId = null;
    let apiKey = '';
    let slackWebhookUrl = '';
    let figmaFileKey = '';
    let figmaFileName = '';
    let figmaUser = null;
    let manualFileKey = ''; // Manual override for local dev

    // Helper function to update file key display
    function updateFileKeyDisplay() {
      const effectiveFileKey = manualFileKey || figmaFileKey;

      const fileStatusEl = document.getElementById('fileStatus');
      const fileKeyDisplayEl = document.getElementById('fileKeyDisplay');
      const fileKeyTextEl = document.getElementById('fileKeyText');
      const fileNameTextEl = document.getElementById('fileNameText');

      if (!effectiveFileKey || effectiveFileKey === '') {
        fileStatusEl.style.display = 'block';
        // fileKeyDisplayEl.style.display = 'none'; // Element commented out in HTML
      } else {
        fileStatusEl.style.display = 'none';
        // fileKeyDisplayEl.style.display = 'block';
        // fileKeyTextEl.textContent = effectiveFileKey + (manualFileKey ? ' (manual)' : '');
        // fileNameTextEl.textContent = figmaFileName;
      }
    }

    // --- Init ---
    // 1. Î®ºÏ†Ä Î©îÏãúÏßÄ Ìï∏Îì§Îü¨Î•º ÏÑ§Ï†ï (ÏùëÎãµÏùÑ Î∞õÏùÑ Ï§ÄÎπÑ)
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      // Local Settings Î°úÎìú (User-level)
      if (msg.type === 'load-api-key') {
        apiKey = msg.apiKey || '';
        console.log('UI: load-api-key received, length:', apiKey.length);
      }
      if (msg.type === 'load-slack-url') {
        slackWebhookUrl = msg.url || '';
        console.log('UI: load-slack-url received, length:', slackWebhookUrl.length);
      }
      if (msg.type === 'load-manual-file-key') {
        manualFileKey = msg.key || '';
        console.log('UI: load-manual-file-key received:', manualFileKey);
        updateFileKeyDisplay();
      }
      if (msg.type === 'load-file-key') {
        figmaFileKey = msg.key || '';
        figmaFileName = msg.name || 'Untitled';
        figmaUser = msg.user;
        console.log('UI: load-file-key received, fileKey:', figmaFileKey, 'fileName:', figmaFileName, 'user:', figmaUser);
        updateFileKeyDisplay();
      }
      
      // Document State Î°úÎìú (Shared Data)
      if (msg.type === 'restore-state') {
        console.log('UI: restore-state received, items:', Array.isArray(msg.data) ? msg.data.length : 'not array');
        items = Array.isArray(msg.data) ? msg.data : [];
        renderList();
        updateBadges();
        console.log('UI: State restored, items in memory:', items.length);
      }

      if (msg.type === 'add-items') {
        console.log('Received add-items:', msg.data);
        // Add new items as DRAFT
        const newItems = msg.data.map(d => ({
          id: d.ids[0],
          ids: d.ids,
          text: d.text,
          status: STATUS.DRAFT, // Overall status
          reviews: { fr: REVIEW_STATUS.PENDING, de: REVIEW_STATUS.PENDING }, // Split review status
          drafts: null,
          final: { fr: '', de: '' }
        }));

        // Merge avoid duplicates
        const existingIds = new Set(items.map(i => i.id));
        newItems.forEach(ni => {
          if (!existingIds.has(ni.id)) {
            items.push(ni);
            console.log('Added item:', ni.text);
          } else {
            console.log('Duplicate item skipped:', ni.text);
          }
        });

        console.log('Total items now:', items.length);
        saveState();
        renderList();
        updateBadges();
      }

      if (msg.type === 'translation-check-result') {
        renderGlossaryMatches(msg.data);
      }

      if (msg.type === 'save-batch-results') {
          // ... (existing code) ...
          if (selectedItemId && msg.data) {
             // ...
          }
      }

      if (msg.type === 'selection-changed') {
          // If the selected item exists in our list, highlight it
          const id = msg.id;
          if (id) {
              const item = items.find(i => i.ids.includes(id));
              if (item) {
                  // If item is found, switch tab if necessary and open detail
                  // Force switch tab if item is not visible in current tab?
                  // Maybe just open detail if it's relevant
                  if (activeTab !== 'all' && item.status.toLowerCase() !== activeTab && item.reviews?.fr !== activeTab && item.reviews?.de !== activeTab) {
                      // Optionally switch tab or just show notification
                  }
                  
                  selectedItemId = item.id;
                  renderList();
                  renderDetail(item);
                  // Scroll to item in list
                  setTimeout(() => {
                      const el = document.querySelector('.item.active');
                      if (el) el.scrollIntoView({ block: 'center', behavior: 'smooth' });
                  }, 100);
              }
          }
      }
    };

    // ========================================
    // UI EVENT HANDLERS
    // ========================================

    /**
     * Tab switching handler
     * Updates active tab and filters the item list
     */
    document.querySelectorAll('.tab').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        activeTab = el.dataset.tab;
        renderList();
        updateFooter();
      };
    });

    /**
     * Render the item list based on current tab filter
     */
    function renderList() {
      const listEl = document.getElementById('list');
      listEl.innerHTML = '';
      
      const filtered = items.filter(i => {
        if (activeTab === 'all') return true;
        if (activeTab === 'draft') return i.status === STATUS.DRAFT;
        if (activeTab === 'review') return (i.status === STATUS.IN_PROGRESS || i.reviews?.fr === REVIEW_STATUS.REQUESTED || i.reviews?.de === REVIEW_STATUS.REQUESTED || i.reviews?.fr === REVIEW_STATUS.APPROVED || i.reviews?.de === REVIEW_STATUS.APPROVED) && i.status !== STATUS.DONE;
        if (activeTab === 'done') return i.status === STATUS.DONE;
        return false;
      });

      if (filtered.length === 0) {
        listEl.innerHTML = '<div class="empty">No items found</div>';
        return;
      }

      // Group by taskId
      const groups = {};
      const noTaskItems = [];

      filtered.forEach(item => {
        if (item.taskId) {
          if (!groups[item.taskId]) groups[item.taskId] = [];
          groups[item.taskId].push(item);
        } else {
          noTaskItems.push(item);
        }
      });

      // Helper to render a single item
      const renderItem = (item) => {
          const div = document.createElement('div');
          div.className = `item ${selectedItemId === item.id ? 'active' : ''}`;
          
          let statusColor = 'status-draft';
          if (item.status === STATUS.DONE) statusColor = 'status-done';
          else if (item.reviews?.fr === REVIEW_STATUS.REQUESTED || item.reviews?.de === REVIEW_STATUS.REQUESTED) statusColor = 'status-review';

          div.innerHTML = `
            <div class="status-indicator ${statusColor}"></div>
            <div style="flex:1; overflow:hidden;">
              <div class="item-content">${escapeHtml(item.text)}</div>
              <div class="item-meta">
                 ${getBadges(item)}
              </div>
            </div>
          `;
          div.onclick = () => {
            selectedItemId = item.id;
            renderList(); 
            renderDetail(item);
          };
          return div;
      };

      // Render Groups (Tasks) - Newest first
      const sortedTaskIds = Object.keys(groups).sort((a, b) => {
          const timeA = parseInt(a.split('_')[1] || 0);
          const timeB = parseInt(b.split('_')[1] || 0);
          return timeB - timeA;
      });

      sortedTaskIds.forEach(taskId => {
          const groupItems = groups[taskId];
          // Format date: e.g. "Jan 10, 10:30 AM"
          const ts = parseInt(taskId.split('_')[1]);
          const date = new Date(ts);
          const dateStr = isNaN(date.getTime()) ? taskId : date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          
          // Get requester name from first item in group
          const requesterName = groupItems[0]?.requesterName || 'Unknown';
          
          const groupDiv = document.createElement('div');
          groupDiv.className = 'task-group';
          
          groupDiv.innerHTML = `
             <div class="task-header">
               <div style="display:flex; flex-direction:column; gap:2px;">
                 <span style="font-size:11px; font-weight:600;">Task ID: ${taskId}</span>
                 <span style="font-size:10px; font-weight:400; opacity:0.8;">by ${escapeHtml(requesterName)} ¬∑ ${dateStr}</span>
               </div>
               <span>${groupItems.length} items</span>
             </div>
             <div class="task-items" id="group-${taskId}"></div>
          `;
          
          listEl.appendChild(groupDiv);
          const container = groupDiv.querySelector(`#group-${taskId}`);
          groupItems.forEach(item => container.appendChild(renderItem(item)));
      });

      // Render Items without Task ID (Legacy or Drafts)
      if (noTaskItems.length > 0) {
          if (sortedTaskIds.length > 0) {
             const header = document.createElement('div');
             header.className = 'section-label';
             header.style.padding = '8px 4px 4px 4px';
             header.style.marginTop = '8px';
             header.innerText = 'Unassigned / Drafts';
             listEl.appendChild(header);
          }
          noTaskItems.forEach(item => listEl.appendChild(renderItem(item)));
      }
      
      updateFooter();
    }
    
    /**
     * Generate status badges for an item
     * Shows language-specific review status
     */
    function getBadges(item) {
        if (item.status === STATUS.DONE) return '‚úÖ Done';
        if (item.status === STATUS.DRAFT) return 'Draft';

        let badges = [];
        if (item.reviews?.fr === REVIEW_STATUS.REQUESTED) badges.push('üá´üá∑ Req');
        if (item.reviews?.fr === REVIEW_STATUS.APPROVED) badges.push('üá´üá∑ OK');
        if (item.reviews?.de === REVIEW_STATUS.REQUESTED) badges.push('üá©üá™ Req');
        if (item.reviews?.de === REVIEW_STATUS.APPROVED) badges.push('üá©üá™ OK');

        return badges.join(' ') || 'Review';
    }

    /**
     * Update tab badge counters
     */
    function updateBadges() {
      const counts = {
        all: items.length,
        draft: items.filter(i => i.status === STATUS.DRAFT).length,
        review: items.filter(i => i.status !== STATUS.DRAFT && i.status !== STATUS.DONE).length,
        done: items.filter(i => i.status === STATUS.DONE).length
      };

      document.getElementById('badge-all').innerText = counts.all;
      document.getElementById('badge-draft').innerText = counts.draft;
      document.getElementById('badge-review').innerText = counts.review;
      document.getElementById('badge-done').innerText = counts.done;
    }

    function updateFooter() {
      const btn = document.getElementById('btnFooterAction');
      
      if (activeTab === 'draft') {
        const count = items.filter(i => i.status === STATUS.DRAFT).length;
        btn.innerText = `Request Review (${count})`;
        btn.disabled = count === 0;
        btn.onclick = () => openReviewRequestModal();
      } else if (activeTab === 'review') {
        // Option: Add 'Approve All' if we wanted, but logic is complex with dual languages
        // For now, simplify to just hint
        btn.innerText = 'Select items to Approve (FR/DE)';
        btn.disabled = true;
      } else {
        btn.innerText = 'Actions available in Draft/Review tabs';
        btn.disabled = true;
      }
    }

    /**
     * Render item detail view (right panel)
     */
    function renderDetail(item) {
      document.getElementById('detailPlaceholder').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';

      // Header
      document.getElementById('detailId').innerText = item.id;
      const badge = document.getElementById('detailStatusBadge');
      badge.className = `status-badge badge-${item.status.toLowerCase()}`;
      badge.innerText = item.status;

      // Source
      document.getElementById('detailSource').innerText = item.text;
      
      // Trigger Rule Match Check
      document.getElementById('glossaryMatches').innerHTML = '<span style="color:#999">Checking...</span>';
      parent.postMessage({ pluginMessage: { type: 'check-translation', text: item.text } }, '*');

      // Draft Section
      const draftSection = document.getElementById('draftSection');
      const reviewSection = document.getElementById('reviewSection');
      // const btnApprove = document.getElementById('btnApprove'); // Removed duplicate declaration

      // Drafts Rendering
      const renderOptions = (lang, options) => {
        if (!options) return '<div style="color:#999; font-style:italic; padding: 12px; text-align:center; background:#FAFAFA; border-radius:6px; border:1px dashed #ddd;">No drafts generated yet. Click "Generate" above.</div>';
        return options.map(opt => `
          <div class="option-card ${item.final[lang] === opt.text ? 'selected' : ''}" 
               onclick="selectDraft('${item.id}', '${lang}', '${escapeHtml(opt.text)}')">
            <div class="option-card-text">${escapeHtml(opt.text)}</div>
            <div class="option-card-nuance">${escapeHtml(opt.nuance)}</div>
          </div>
        `).join('');
      };

      document.getElementById('draftsFr').innerHTML = renderOptions('fr', item.drafts?.fr);
      document.getElementById('draftsDe').innerHTML = renderOptions('de', item.drafts?.de);

      // Visibility based on Status & Role
      const btnApproveFr = document.getElementById('btnApproveFr');
      const btnApproveDe = document.getElementById('btnApproveDe');
      
      btnApproveFr.style.display = 'none';
      btnApproveDe.style.display = 'none';

      if (activeTab === 'review' || item.status === STATUS.IN_PROGRESS || (item.reviews?.fr && item.reviews?.fr !== REVIEW_STATUS.PENDING) || (item.reviews?.de && item.reviews?.de !== REVIEW_STATUS.PENDING)) {
          reviewSection.style.display = 'block';
          
          btnApproveFr.style.display = 'inline-flex';
          btnApproveDe.style.display = 'inline-flex';
          
          // French Button State
          btnApproveFr.className = 'btn-approve';
          if (item.reviews?.fr === REVIEW_STATUS.APPROVED) {
              btnApproveFr.innerText = "üá´üá∑ Approved ‚úì";
              btnApproveFr.disabled = true;
              btnApproveFr.classList.add('approved');
          } else if (item.reviews?.fr === REVIEW_STATUS.REQUESTED) {
              btnApproveFr.innerText = "üá´üá∑ Approve French";
              btnApproveFr.disabled = false;
              btnApproveFr.onclick = () => approveSingle(item, 'fr');
          } else {
              btnApproveFr.innerText = "üá´üá∑ Not Requested";
              btnApproveFr.disabled = true;
              btnApproveFr.classList.add('approved');
          }

          // German Button State
          btnApproveDe.className = 'btn-approve';
          if (item.reviews?.de === REVIEW_STATUS.APPROVED) {
              btnApproveDe.innerText = "üá©üá™ Approved ‚úì";
              btnApproveDe.disabled = true;
              btnApproveDe.classList.add('approved');
          } else if (item.reviews?.de === REVIEW_STATUS.REQUESTED) {
              btnApproveDe.innerText = "üá©üá™ Approve German";
              btnApproveDe.disabled = false;
              btnApproveDe.onclick = () => approveSingle(item, 'de');
          } else {
              btnApproveDe.innerText = "üá©üá™ Not Requested";
              btnApproveDe.disabled = true;
              btnApproveDe.classList.add('approved');
          }
      } else {
          // Draft or Done or All (if not in progress)
          reviewSection.style.display = 'block'; // Always show review/edit section
      }

      // Populate Edit Fields
      document.getElementById('editFr').value = item.final.fr || '';
      document.getElementById('editDe').value = item.final.de || '';
      
      // Auto-save and auto-resize edit fields
      const editFr = document.getElementById('editFr');
      const editDe = document.getElementById('editDe');
      
      editFr.oninput = (e) => { 
        item.final.fr = e.target.value; 
        saveState(); 
        autoResizeTextarea(e.target);
      };
      editDe.oninput = (e) => { 
        item.final.de = e.target.value; 
        saveState(); 
        autoResizeTextarea(e.target);
      };
      
      // Initial auto-resize
      autoResizeTextarea(editFr);
      autoResizeTextarea(editDe);
      
      // Focus Action
      document.getElementById('btnFocus').onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'focus-nodes', ids: item.ids } }, '*');
      };

      // Delete Action
      const btnDeleteItem = document.getElementById('btnDeleteItem');
      const btnRegen = document.getElementById('btnRegen');
      const isDone = item.status === STATUS.DONE;
      
      // Disable buttons for Done items
      btnDeleteItem.disabled = isDone;
      btnRegen.disabled = isDone;
      
      btnDeleteItem.onclick = isDone ? null : () => {
         if (!confirm('Remove this item from list?')) return;
         const idx = items.findIndex(i => i.id === item.id);
         if (idx > -1) {
             items.splice(idx, 1);
             parent.postMessage({ pluginMessage: { type: 'clear-highlights', ids: item.ids } }, '*');
             saveState();
             selectedItemId = null;
             document.getElementById('detailPlaceholder').style.display = 'block';
             document.getElementById('detailContent').style.display = 'none';
             renderList();
             updateBadges();
         }
      };
      
      // Regen Action
      btnRegen.onclick = isDone ? null : () => generateDraftsForSingle(item);
      
      // Language Apply Toggle Buttons
      const btnApplyFr = document.getElementById('btnApplyFr');
      const btnApplyDe = document.getElementById('btnApplyDe');
      
      // Set initial state based on item.appliedLang
      const isFrActive = item.appliedLang === 'fr';
      const isDeActive = item.appliedLang === 'de';
      
      btnApplyFr.className = 'btn-apply' + (isFrActive ? ' active' : '');
      btnApplyDe.className = 'btn-apply' + (isDeActive ? ' active' : '');
      
      btnApplyFr.innerText = isFrActive ? 'Applied ‚úì' : 'Apply to Canvas';
      btnApplyDe.innerText = isDeActive ? 'Applied ‚úì' : 'Apply to Canvas';
      
      btnApplyFr.onclick = () => toggleApplyTranslation(item, 'fr');
      btnApplyDe.onclick = () => toggleApplyTranslation(item, 'de');
    }
    
    /**
     * Toggle translation application to Figma canvas
     */
    function toggleApplyTranslation(item, lang) {
      const currentlyApplied = item.appliedLang === lang;
      
      if (currentlyApplied) {
        // Revert to original English
        parent.postMessage({ 
          pluginMessage: { 
            type: 'apply-text', 
            ids: item.ids, 
            text: item.text // Original English text
          } 
        }, '*');
        item.appliedLang = null;
      } else {
        // Apply translation
        const translatedText = item.final[lang];
        if (!translatedText) {
          alert(`No ${lang === 'fr' ? 'French' : 'German'} translation available. Please generate or enter a translation first.`);
          return;
        }
        parent.postMessage({ 
          pluginMessage: { 
            type: 'apply-text', 
            ids: item.ids, 
            text: translatedText
          } 
        }, '*');
        item.appliedLang = lang;
      }
      
      saveState();
      renderDetail(item);
    }

    /**
     * Display glossary matches from existing resources
     */
    function renderGlossaryMatches(matches) {
        const el = document.getElementById('glossaryMatches');
        const section = document.getElementById('glossarySection');
        
        if (!matches || matches.length === 0) {
            el.innerHTML = '<div style="color:#999; text-align:center; padding:8px;">No matches found in glossary</div>';
            return;
        }
        
        el.innerHTML = matches.map((m, i) => `
            <div style="padding:10px; ${i > 0 ? 'border-top:1px solid #E5E7EB;' : ''}">
               <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                 <span style="font-weight:600; color:#0F766E; font-size:11px;">${m.key}</span>
                 <span style="font-size:10px; padding:2px 6px; background:#E0F2FE; color:#0369A1; border-radius:4px;">${m.type}</span>
               </div>
               <div style="font-size:12px; color:#333; margin-bottom:4px;">üá¨üáß ${escapeHtml(m.value)}</div>
               ${m.frValue ? `<div style="font-size:11px; color:#666;">üá´üá∑ ${escapeHtml(m.frValue)}</div>` : ''}
               ${m.deValue ? `<div style="font-size:11px; color:#666;">üá©üá™ ${escapeHtml(m.deValue)}</div>` : ''}
            </div>
        `).join('');
    }

    // ========================================
    // USER ACTIONS
    // ========================================

    /**
     * Select a draft translation option
     */
    window.selectDraft = (itemId, lang, text) => {
      const item = items.find(i => i.id === itemId);
      if (item) {
        item.final[lang] = text;
        renderDetail(item);
        saveState();
      }
    };

    /**
     * Generate AI translation drafts for a single item
     */
    function generateDraftsForSingle(item) {
        if (!apiKey) {
            alert('Please set API Key in settings');
            return;
        }
        
        const btn = document.getElementById('btnRegen');
        btn.innerText = "Generating...";
        
        // Construct prompt (Simplified for this file)
        // In real app, this would use the robust prompt construction from before
        fetch(OPENAI_CONFIG.API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: OPENAI_CONFIG.MODEL,
                messages: [{  
                    role: "user", 
                    content: `Translate to French and German. JSON format: {"fr": [{"text":"...", "nuance":"..."}], "de": [...]}. Text: "${item.text}"` 
                }],
                response_format: { type: "json_object" }
            })
        })
        .then(res => res.json())
        .then(data => {
            const content = JSON.parse(data.choices[0].message.content);
            item.drafts = { fr: content.fr, de: content.de };
            if(!item.final.fr) item.final.fr = content.fr[0]?.text;
            if(!item.final.de) item.final.de = content.de[0]?.text;
            saveState();
            renderDetail(item);
            btn.innerText = "Generate Drafts";
        })
        .catch(err => {
            alert("Error: " + err.message);
            btn.innerText = "Generate Drafts";
        });
    }

    /**
     * Send notification to Slack via webhook
     * Uses no-cors mode to bypass browser restrictions
     */
    function sendToSlack(payload) {
        if (!slackWebhookUrl) {
            alert('Slack Webhook URL is missing. Please set it in Settings.');
            return;
        }

        // Note: no-cors mode prevents reading response, but sends the request
        fetch(slackWebhookUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            alert('Notification sent to Slack!');
        })
        .catch(err => {
            console.error(err);
            alert('Failed to send to Slack (Check Console).');
        });
    }

    /**
     * Open review request modal and send Slack notifications
     * Allows selecting French and/or German for review
     */
    function openReviewRequestModal() {
        const effectiveFileKey = getEffectiveFileKey();
        console.log('openReviewRequestModal called', effectiveFileKey);
        console.log('Using figmaFileName:', figmaFileName);
        console.log('Using figmaUser:', figmaUser);

        if (!effectiveFileKey) {
            alert("Figma File Key is missing.\n\nFor local development:\n1. Open this file in browser: figma.com\n2. Copy the file key from URL\n3. Go to Settings (‚öôÔ∏è) and paste it in 'Figma File Key'\n\nOr save your file to a project (not Drafts) and restart the plugin.");
            return;
        }

        // Just use a simple confirm for now, or add checkbox for languages
        // Let's prompt for language selection
        const reqFr = confirm("Request French Review? (Cancel to skip)");
        const reqDe = confirm("Request German Review? (Cancel to skip)");

        if (!reqFr && !reqDe) return;

        const list = items.filter(i => i.status === STATUS.DRAFT);
        
        // Generate a unique Task ID for this batch
        const now = new Date();
        const taskId = 'task_' + now.getTime();
        const taskTime = now.toLocaleString();
        
        const requesterName = figmaUser ? figmaUser.name : "Unknown User";
        
        list.forEach(i => {
            if (reqFr) i.reviews.fr = REVIEW_STATUS.REQUESTED;
            if (reqDe) i.reviews.de = REVIEW_STATUS.REQUESTED;
            i.status = STATUS.IN_PROGRESS;
            i.taskId = taskId;
            i.requesterName = requesterName;
        });

        saveState();
        renderList();
        updateBadges();

        // Build Figma links
        const baseLinks = buildFigmaLinks();
        // const firstItemLinks = list.length > 0 ? buildFigmaLinks(list[0].id) : null; // Removed per request to have only one main link

        // Prepare Slack notification blocks
        const languages = [];
        if (reqFr) languages.push("üá´üá∑ French");
        if (reqDe) languages.push("üá©üá™ German");
        
        let blocks = [
            {
                type: "header",
                text: {
                    type: "plain_text",
                    text: "üöÄ New Translation Request",
                    emoji: true
                }
            },
            {
                type: "context",
                elements: [
                    {
                        type: "mrkdwn",
                        text: "üî¥ *Please check in the Review tab!*"
                    }
                ]
            },
            {
                type: "section",
                fields: [
                    {
                        type: "mrkdwn",
                        text: `*Time:*\n${taskTime}`
                    },
                    {
                        type: "mrkdwn",
                        text: `*Requester:*\n${requesterName}`
                    }
                ]
            },
            {
                type: "section",
                fields: [
                    {
                        type: "mrkdwn",
                        text: `*File:*\n${figmaFileName}`
                    },
                    {
                        type: "mrkdwn",
                        text: `*Task ID:*\n${taskId}`
                    }
                ]
            },
            {
                type: "section",
                fields: [
                    {
                        type: "mrkdwn",
                        text: `*Items:*\n${list.length} text nodes`
                    },
                    {
                        type: "mrkdwn",
                        text: `*Languages:*\n${languages.join(", ")}`
                    }
                ]
            },
            {
                type: "divider"
            },
            {
                type: "actions",
                elements: [
                    {
                        type: "button",
                        text: {
                            type: "plain_text",
                            text: "Open in Browser",
                            emoji: true
                        },
                        url: baseLinks.web,
                        style: "primary"
                    },
                    {
                        type: "button",
                        text: {
                            type: "plain_text",
                            text: "Open in Desktop App",
                            emoji: true
                        },
                        url: baseLinks.desktop
                    }
                ]
            }
        ];

        const payload = {
            text: `New Translation Request from ${requesterName}`,
            blocks: blocks
        };

        sendToSlack(payload);
    }
    
    function approveSingle(item, lang) {
        if (!item.reviews) return;
        item.reviews[lang] = REVIEW_STATUS.APPROVED;

        // Check if all requested reviews are now approved
        const frPending = item.reviews.fr === REVIEW_STATUS.REQUESTED;
        const dePending = item.reviews.de === REVIEW_STATUS.REQUESTED;
        
        if (!frPending && !dePending) {
            item.status = STATUS.DONE;

            // Check if this was the last item in the task
            if (item.taskId) {
                const taskItems = items.filter(i => i.taskId === item.taskId);
                const allDone = taskItems.every(i => i.status === STATUS.DONE);

                if (allDone) {
                    // Send Slack Notification for TASK completion
                    if (getEffectiveFileKey()) {
                        const links = buildFigmaLinks();
                        const now = new Date();
                        const completionTime = now.toLocaleString();
                        const taskRequester = item.requesterName || 'Unknown User';
                        
                        // Count approved languages
                        const approvedLangs = [];
                        if (taskItems.some(i => i.reviews?.fr === REVIEW_STATUS.APPROVED)) approvedLangs.push("French üá´üá∑");
                        if (taskItems.some(i => i.reviews?.de === REVIEW_STATUS.APPROVED)) approvedLangs.push("German üá©üá™");
                        
                        const payload = {
                            text: `‚úÖ Translation Task Completed`,
                            blocks: [
                                {
                                    type: "header",
                                    text: {
                                        type: "plain_text",
                                        text: "‚úÖ Translation Task Completed",
                                        emoji: true
                                    }
                                },
                                {
                                    type: "context",
                                    elements: [
                                        {
                                            type: "mrkdwn",
                                            text: "üü¢ *All translations have been approved!*"
                                        }
                                    ]
                                },
                                {
                                    type: "section",
                                    fields: [
                                        {
                                            type: "mrkdwn",
                                            text: `*Completion Time:*\n${completionTime}`
                                        },
                                        {
                                            type: "mrkdwn",
                                            text: `*Requester:*\n${taskRequester}`
                                        }
                                    ]
                                },
                                {
                                    type: "section",
                                    fields: [
                                        {
                                            type: "mrkdwn",
                                            text: `*File:*\n${figmaFileName}`
                                        },
                                        {
                                            type: "mrkdwn",
                                            text: `*Task ID:*\n${item.taskId}`
                                        }
                                    ]
                                },
                                {
                                    type: "section",
                                    fields: [
                                        {
                                            type: "mrkdwn",
                                            text: `*Items:*\n${taskItems.length} text nodes`
                                        },
                                        {
                                            type: "mrkdwn",
                                            text: `*Languages:*\n${approvedLangs.join(", ")}`
                                        }
                                    ]
                                },
                                {
                                    type: "divider"
                                },
                                {
                                    type: "actions",
                                    elements: [
                                        {
                                            type: "button",
                                            text: { type: "plain_text", text: "Open in Browser", emoji: true },
                                            url: links.web,
                                            style: "primary"
                                        },
                                        {
                                            type: "button",
                                            text: { type: "plain_text", text: "Open in Desktop App", emoji: true },
                                            url: links.desktop
                                        }
                                    ]
                                }
                            ]
                        };
                        sendToSlack(payload);
                    }
                }
            }
        }
        
        saveState();
        renderList();
        renderDetail(item);
        updateBadges();
    }

    // --- Helpers ---
    function saveState() {
      console.log('UI: saveState called, items:', items.length);
      // items Î∞∞Ïó¥Ïù¥ Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏
      const dataToSave = Array.isArray(items) ? items : [];
      parent.postMessage({ pluginMessage: { type: 'save-state', data: dataToSave } }, '*');
    }

    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      // Reset height to auto to get the correct scrollHeight
      textarea.style.height = 'auto';
      // Set height to scrollHeight (content height)
      const newHeight = Math.min(Math.max(textarea.scrollHeight, 40), 200);
      textarea.style.height = newHeight + 'px';
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    /**
     * Normalize Figma node ID for use in deep links
     * Converts "I98:2814;3019:15922" to "I98-2814"
     */
    function normalizeNodeId(nodeId) {
      return nodeId.split(';')[0].replace(/:/g, '-');
    }

    /**
     * Get the effective file key (manual override or auto-detected)
     */
    function getEffectiveFileKey() {
      return manualFileKey || figmaFileKey;
    }

    /**
     * Encode file name for use in URLs
     */
    function encodeFileName(fileName) {
      return fileName ? encodeURIComponent(fileName) : 'Untitled';
    }

    /**
     * Build Figma deep links for both web and desktop
     */
    function buildFigmaLinks(nodeId = null) {
      const effectiveFileKey = getEffectiveFileKey();
      const fileNameEncoded = encodeFileName(figmaFileName);

      const baseWeb = `${FIGMA_URLS.WEB}/${effectiveFileKey}/${fileNameEncoded}`;
      const baseDesktop = `${FIGMA_URLS.DESKTOP}/${effectiveFileKey}`;

      if (nodeId) {
        const normalizedId = normalizeNodeId(nodeId);
        return {
          web: `${baseWeb}?node-id=${normalizedId}`,
          desktop: `${baseDesktop}?node-id=${normalizedId}`
        };
      }

      return { web: baseWeb, desktop: baseDesktop };
    }

    // --- Buttons ---
    document.getElementById('btnAdd').onclick = () => {
      console.log('Add button clicked - sending add-selection message');
      parent.postMessage({ pluginMessage: { type: 'add-selection' } }, '*');
    };
    document.getElementById('btnClear').onclick = () => { 
      items = []; 
      saveState(); 
      renderList(); 
      updateBadges(); 
      parent.postMessage({ pluginMessage: { type: 'clear-highlights' } }, '*');
    };
    document.getElementById('btnSettings').onclick = () => {
        document.getElementById('apiKeyInput').value = apiKey;
        document.getElementById('slackUrlInput').value = slackWebhookUrl;
        document.getElementById('fileKeyInput').value = manualFileKey;
        document.getElementById('settingsModal').style.display = 'flex';
    };
    document.getElementById('btnCloseKey').onclick = () => document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('btnSaveKey').onclick = () => {
        const key = document.getElementById('apiKeyInput').value || '';
        const url = document.getElementById('slackUrlInput').value || '';
        const fileKey = document.getElementById('fileKeyInput').value.trim() || '';

        console.log('UI: Saving settings - apiKey length:', key.length, 'slackUrl length:', url.length, 'fileKey:', fileKey);

        apiKey = key;
        slackWebhookUrl = url;
        manualFileKey = fileKey;

        // Ìï≠ÏÉÅ Ï†ÄÏû• (Îπà Í∞íÎèÑ Ï†ÄÏû•ÌïòÏó¨ ÏÇ≠Ï†ú Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        parent.postMessage({ pluginMessage: { type: 'save-api-key', apiKey: key } }, '*');
        parent.postMessage({ pluginMessage: { type: 'save-slack-url', url: url } }, '*');
        parent.postMessage({ pluginMessage: { type: 'save-manual-file-key', key: fileKey } }, '*');

        updateFileKeyDisplay();
        document.getElementById('settingsModal').style.display = 'none';
        
        console.log('UI: Settings saved');
    };

    // 2. Î™®Îì† Ìï∏Îì§Îü¨ÏôÄ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ïÏù¥ ÏôÑÎ£åÎêú ÌõÑ ui-ready Ï†ÑÏÜ°
    // Ïù¥Î†áÍ≤å Ìï¥Ïïº pluginÏóêÏÑú Î≥¥ÎÇ¥Îäî restore-state Îì±Ïùò Î©îÏãúÏßÄÎ•º Î∞õÏùÑ Ï§ÄÎπÑÍ∞Ä Îê®
    console.log('UI: All handlers registered, sending ui-ready');
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');

  </script>
</body>
</html>
